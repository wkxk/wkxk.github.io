<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="JavaScript,Vue2,Vue3,Vite,Webpack,node"><meta name="description" content="wkxk的个人博客，主要涉及到编程(JavaScript,Vue2,Vue3,Webpack,node),助于个人学习提升，分享学习过程"><meta name="author" content="wkxk"><title>Vue响应式原理模拟 | wkxk&#39;s Blog</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/logo.7kmeykeizco0.svg"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/css/font-awesome.min.css"><script id="hexo-configurations">let KEEP=window.KEEP||{};KEEP.hexo_config={hostname:"www.iwkxk.com",root:"/",language:"zh",path:"search.xml"},KEEP.theme_config={toc:{enable:!0,number:!0,expand_all:!0,init_open:!0},style:{primary_color:"#0066CC",avatar:"https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/avator.2use3mem6940.svg",favicon:"https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/logo.7kmeykeizco0.svg",article_img_align:"left",left_side_width:"260px",content_max_width:"920px",hover:{shadow:!0,scale:!0},first_screen:{enable:!0,background_img:"/images/bg.svg",description:"愿你眼里有光，眼底无霜，心有大海，胸无睚眦。风尘自仆仆，你我当归人。"},scroll:{progress_bar:{enable:!0},percent:{enable:!0}}},local_search:{enable:!0,preload:!0},code_copy:{enable:!0,style:"default"},pjax:{enable:!0},lazyload:{enable:!0},version:"3.4.2"},KEEP.language_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"}</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="progress-bar-container"><span class="scroll-progress-bar"></span> <span class="pjax-progress-bar"></span> <span class="pjax-progress-icon"><i class="fas fa-circle-notch fa-spin"></i></span></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-title" href="/">wkxk&#39;s Blog</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">HOME</a></li><li class="menu-item"><a href="/archives">ARCHIVES</a></li><li class="menu-item"><a href="/links">LINKS</a></li><li class="menu-item"><a href="/about">ABOUT</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">HOME</a></li><li class="drawer-menu-item flex-center"><a href="/archives">ARCHIVES</a></li><li class="drawer-menu-item flex-center"><a href="/links">LINKS</a></li><li class="drawer-menu-item flex-center"><a href="/about">ABOUT</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">Vue响应式原理模拟</span></div><div class="article-header"><div class="avatar"><img src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/avator.2use3mem6940.svg"></div><div class="info"><div class="author"><span class="name">wkxk</span> <span class="author-label">前端攻城狮</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fas fa-edit"></i>&nbsp;2021-04-23 10:41:32 </span><span class="article-categories article-meta-item"><i class="fas fa-folder"></i>&nbsp;<ul><li><a href="/categories/Vue%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/">Vue源码剖析</a>&nbsp;</li></ul></span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/Vue%E5%93%8D%E5%BA%94%E5%BC%8F/">Vue响应式</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>3.2k Words</span> </span><span class="article-min2read article-meta-item"><i class="fas fa-clock"></i>&nbsp;<span>14 Mins</span> </span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body"><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a><strong>准备工作</strong></h2><ul><li><p>数据驱动</p></li><li><p>响应式的核心原理</p></li><li><p>发布订阅模式和观察者模式</p></li></ul><h2 id="数据驱动"><a href="#数据驱动" class="headerlink" title="数据驱动"></a><strong>数据驱动</strong></h2><ul><li><p>数据响应式、双向绑定、数据驱动</p></li><li><p>数据响应式</p><ul><li>数据模型仅仅是普通的 JavaScript 对象，而当我们修改数据时，视图会进行更新，避免了繁琐的 DOM 操作，提高开发效率</li></ul></li><li><p>双向绑定</p><ul><li>数据改变，视图改变；视图改变，数据也随之改变</li><li>我们可以使用 v-model 在表单元素上创建双向数据绑定</li></ul></li><li><p>数据驱动是 Vue 最独特的特性之一</p><ul><li>开发过程中仅需要关注数据本身，不需要关心数据是如何渲染到视图</li></ul></li></ul><h2 id="数据响应式的核心原理"><a href="#数据响应式的核心原理" class="headerlink" title="数据响应式的核心原理"></a><strong>数据响应式的核心原理</strong></h2><h3 id="Vue-2-x"><a href="#Vue-2-x" class="headerlink" title="Vue 2.x"></a><strong>Vue 2.x</strong></h3><ul><li><p>Vue 2.x深入响应式原理</p></li><li><p>MDN - Object.defifineProperty</p></li><li><p>浏览器兼容 IE8 以上（不兼容 IE8）</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟 Vue 中的 data 选项 </span></span><br><span class="line"><span class="keyword">let</span> data = &#123; <span class="attr">msg</span>: <span class="string">&#x27;hello&#x27;</span> &#125;</span><br><span class="line"><span class="comment">// 模拟 Vue 的实例 </span></span><br><span class="line"><span class="keyword">let</span> vm = &#123;&#125; </span><br><span class="line"><span class="comment">// 数据劫持：当访问或者设置 vm 中的成员的时候，做一些干预操作</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(vm, <span class="string">&#x27;msg&#x27;</span>, &#123; </span><br><span class="line">  <span class="comment">// 可枚举（可遍历） </span></span><br><span class="line">  enumerable: <span class="literal">true</span>, </span><br><span class="line">  <span class="comment">// 可配置（可以使用 delete 删除，可以通过 defineProperty 重新定义） </span></span><br><span class="line">  configurable: <span class="literal">true</span>, </span><br><span class="line">  <span class="comment">// 当获取值的时候执行 </span></span><br><span class="line">  get () &#123; </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;get: &#x27;</span>, data.msg) </span><br><span class="line">    <span class="keyword">return</span> data.msg </span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 当设置值的时候执行 </span></span><br><span class="line">  set (newValue) &#123; </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;set: &#x27;</span>, newValue)</span><br><span class="line">    <span class="keyword">if</span> (newValue === data.msg) &#123; </span><br><span class="line">      <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    data.msg = newValue </span><br><span class="line">    <span class="comment">// 数据更改，更新 DOM 的值 </span></span><br><span class="line">    <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#app&#x27;</span>).textContent = data.msg </span><br><span class="line">  &#125; </span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 测试</span></span><br><span class="line">vm.msg = <span class="string">&#x27;Hello World&#x27;</span> </span><br><span class="line"><span class="built_in">console</span>.log(vm.msg)</span><br></pre></td></tr></table></figure><ul><li>如果有一个对象中多个属性需要转换 getter/setter 如何处理？</li></ul><h3 id="Vue-3-x"><a href="#Vue-3-x" class="headerlink" title="Vue 3.x"></a><strong>Vue 3.x</strong></h3><ul><li><p>MDN - Proxy</p></li><li><p>直接监听对象，而非属性。</p></li><li><p>ES 6中新增，IE 不支持，性能由浏览器优化</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟 Vue 中的 data 选项 </span></span><br><span class="line"><span class="keyword">let</span> data = &#123; <span class="attr">msg</span>: <span class="string">&#x27;hello&#x27;</span>, <span class="attr">count</span>: <span class="number">0</span> &#125;</span><br><span class="line"><span class="comment">// 模拟 Vue 实例 </span></span><br><span class="line"><span class="keyword">let</span> vm = <span class="keyword">new</span> <span class="built_in">Proxy</span>(data, &#123; </span><br><span class="line">  <span class="comment">// 当访问 vm 的成员会执行 </span></span><br><span class="line">  get (target, key) &#123; </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;get, key: &#x27;</span>, key, target[key]) </span><br><span class="line">    <span class="keyword">return</span> target[key] </span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 当设置 vm 的成员会执行 </span></span><br><span class="line">  set (target, key, newValue) &#123; </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;set, key: &#x27;</span>, key, newValue) </span><br><span class="line">    <span class="keyword">if</span> (target[key] === newValue) &#123; </span><br><span class="line">      <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    target[key] = newValue </span><br><span class="line">    <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#app&#x27;</span>).textContent = target[key] </span><br><span class="line">  &#125; </span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 测试 </span></span><br><span class="line">vm.msg = <span class="string">&#x27;Hello World&#x27;</span> </span><br><span class="line"><span class="built_in">console</span>.log(vm.msg)</span><br></pre></td></tr></table></figure><h2 id="发布订阅模式和观察者模式"><a href="#发布订阅模式和观察者模式" class="headerlink" title="发布订阅模式和观察者模式"></a><strong>发布订阅模式和观察者模式</strong></h2><h3 id="发布-订阅模式"><a href="#发布-订阅模式" class="headerlink" title="发布/订阅模式"></a><strong>发布/订阅模式</strong></h3><ul><li>发布/订阅模式<ul><li>订阅者</li><li>发布者</li><li>信号中心</li></ul></li></ul><blockquote><p>我们假定，存在一个”信号中心”，某个任务执行完成，就向信号中心”发布”（publish）一个信号，其他任务可以向信号中心”订阅”（subscribe）这个信号，从而知道什么时候自己可以开始执行。<strong>这就叫做发布/订阅模式（publish-subscribe pattern）</strong></p></blockquote><ul><li>Vue 的自定义事件<ul><li><a class="link" target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/migration.html#dispatch-%E5%92%8C-broadcast-%E6%9B%BF%E6%8D%A2">https://cn.vuejs.org/v2/guide/migration.html#dispatch-%E5%92%8C-broadcast-%E6%9B%BF%E6%8D%A2<i class="fas fa-external-link-alt"></i></a></li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> vm = <span class="keyword">new</span> Vue() </span><br><span class="line">vm.$on(<span class="string">&#x27;dataChange&#x27;</span>, <span class="function">() =&gt;</span> &#123; </span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;dataChange&#x27;</span>) </span><br><span class="line">&#125;)</span><br><span class="line">vm.$on(<span class="string">&#x27;dataChange&#x27;</span>, <span class="function">() =&gt;</span> &#123; </span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;dataChange1&#x27;</span>) </span><br><span class="line">&#125;)</span><br><span class="line">vm.$emit(<span class="string">&#x27;dataChange&#x27;</span>)</span><br></pre></td></tr></table></figure><ul><li>兄弟组件通信过程</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eventBus.js </span></span><br><span class="line"><span class="comment">// 事件中心 </span></span><br><span class="line"><span class="keyword">let</span> eventHub = <span class="keyword">new</span> Vue() </span><br><span class="line"><span class="comment">// ComponentA.vue </span></span><br><span class="line"><span class="comment">// 发布者 addTodo: </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; </span><br><span class="line">  <span class="comment">// 发布消息(事件) </span></span><br><span class="line">  eventHub.$emit(<span class="string">&#x27;add-todo&#x27;</span>, &#123; </span><br><span class="line">    text: <span class="built_in">this</span>.newTodoText </span><br><span class="line">  &#125;) </span><br><span class="line">  <span class="built_in">this</span>.newTodoText = <span class="string">&#x27;&#x27;</span> </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ComponentB.vue </span></span><br><span class="line"><span class="comment">// 订阅者 created: </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; </span><br><span class="line">  <span class="comment">// 订阅消息(事件) </span></span><br><span class="line">  eventHub.$on(<span class="string">&#x27;add-todo&#x27;</span>, <span class="built_in">this</span>.addTodo) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>模拟 Vue 自定义事件的实现</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventEmitter</span> </span>&#123; </span><br><span class="line">  <span class="title">constructor</span> (<span class="params"></span>) &#123; </span><br><span class="line">    <span class="comment">// &#123; eventType: [ handler1, handler2 ] &#125; </span></span><br><span class="line">    <span class="built_in">this</span>.subs = &#123;&#125; </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 订阅通知 </span></span><br><span class="line">  $on (eventType, handler) &#123; </span><br><span class="line">    <span class="built_in">this</span>.subs[eventType] = <span class="built_in">this</span>.subs[eventType] || [] </span><br><span class="line">    <span class="built_in">this</span>.subs[eventType].push(handler) </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 发布通知 </span></span><br><span class="line">  $emit (eventType) &#123; </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.subs[eventType]) &#123; </span><br><span class="line">      <span class="built_in">this</span>.subs[eventType].forEach(<span class="function"><span class="params">handler</span> =&gt;</span> &#123; </span><br><span class="line">        handler() </span><br><span class="line">      &#125;) </span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 测试 </span></span><br><span class="line"><span class="keyword">var</span> bus = <span class="keyword">new</span> EventEmitter() </span><br><span class="line"><span class="comment">// 注册事件 </span></span><br><span class="line">bus.$on(<span class="string">&#x27;click&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; </span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;click&#x27;</span>) </span><br><span class="line">&#125;)</span><br><span class="line">bus.$on(<span class="string">&#x27;click&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; </span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;click1&#x27;</span>) </span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 触发事件 </span></span><br><span class="line">bus.$emit(<span class="string">&#x27;click&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a><strong>观察者模式</strong></h3><ul><li><p>观察者(订阅者) – Watcher</p><ul><li>update()：当事件发生时，具体要做的事情</li></ul></li><li><p>目标(发布者) – Dep</p><ul><li>subs 数组：存储所有的观察者</li><li>addSub()：添加观察者</li><li>notify()：当事件发生，调用所有观察者的 update() 方法</li></ul></li><li><p>没有事件中心</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 目标(发布者) </span></span><br><span class="line"><span class="comment">// Dependency </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123; </span><br><span class="line">  <span class="title">constructor</span> (<span class="params"></span>) &#123; </span><br><span class="line">    <span class="comment">// 存储所有的观察者 </span></span><br><span class="line">    <span class="built_in">this</span>.subs = [] </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 添加观察者 </span></span><br><span class="line">  addSub (sub) &#123; </span><br><span class="line">    <span class="keyword">if</span> (sub &amp;&amp; sub.update) &#123;</span><br><span class="line">      <span class="built_in">this</span>.subs.push(sub) </span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 通知所有观察者 </span></span><br><span class="line">  notify () &#123; </span><br><span class="line">    <span class="built_in">this</span>.subs.forEach(<span class="function"><span class="params">sub</span> =&gt;</span> &#123; </span><br><span class="line">      sub.update() </span><br><span class="line">    &#125;) </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 观察者(订阅者) </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123; </span><br><span class="line">  update () &#123; </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;update&#x27;</span>) </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 测试 </span></span><br><span class="line"><span class="keyword">let</span> dep = <span class="keyword">new</span> Dep() </span><br><span class="line"><span class="keyword">let</span> watcher = <span class="keyword">new</span> Watcher() </span><br><span class="line">dep.addSub(watcher) </span><br><span class="line">dep.notify()</span><br></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h3><ul><li><p><strong>观察者模式</strong>是由具体目标调度，比如当事件触发，Dep 就会去调用观察者的方法，所以观察者模式的订阅者与发布者之间是存在依赖的。</p></li><li><p><strong>发布/订阅模式</strong>由统一调度中心调用，因此发布者和订阅者不需要知道对方的存在。</p></li></ul><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20210423114525801.5zq60vp6pao0.png" alt="image-20210423114525801"></p><h2 id="Vue-响应式原理模拟"><a href="#Vue-响应式原理模拟" class="headerlink" title="Vue 响应式原理模拟"></a><strong>Vue</strong> <strong>响应式原理模拟</strong></h2><h3 id="整体分析"><a href="#整体分析" class="headerlink" title="整体分析"></a><strong>整体分析</strong></h3><ul><li><p>Vue 基本结构</p></li><li><p>打印 Vue 实例观察</p></li><li><p>整体结构</p></li></ul><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20210423114620375.24ixunec4ulc.png" alt="image-20210423114620375"></p><ul><li><p>Vue</p><ul><li>把 data 中的成员注入到 Vue 实例，并且把 data 中的成员转成 getter/setter</li></ul></li><li><p>Observer</p><ul><li>能够对数据对象的所有属性进行监听，如有变动可拿到最新值并通知 Dep</li></ul></li><li><p>Compiler</p><ul><li>解析每个元素中的指令/插值表达式，并替换成相应的数据</li></ul></li><li><p>Dep</p><ul><li>添加观察者(watcher)，当数据变化通知所有观察者</li></ul></li><li><p>Watcher</p><ul><li>数据变化更新视图</li></ul></li></ul><h3 id="Vue"><a href="#Vue" class="headerlink" title="Vue"></a><strong>Vue</strong></h3><ul><li><p>功能</p><ul><li>负责接收初始化的参数(选项)</li><li>负责把 data 中的属性注入到 Vue 实例，转换成 getter/setter</li><li>负责调用 observer 监听 data 中所有属性的变化</li><li>负责调用 compiler 解析指令/插值表达式</li></ul></li><li><p>结构</p><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20210423114725936.1dxh5c3ekji8.png" alt="image-20210423114725936"></p></li><li><p>代码</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vue</span> </span>&#123; </span><br><span class="line">  <span class="title">constructor</span> (<span class="params">options</span>) &#123; </span><br><span class="line">    <span class="comment">// 1. 保存选项的数据 </span></span><br><span class="line">    <span class="built_in">this</span>.$options = options || &#123;&#125; </span><br><span class="line">    <span class="built_in">this</span>.$data = options.data || &#123;&#125; </span><br><span class="line">    <span class="keyword">const</span> el = options.el </span><br><span class="line">    <span class="built_in">this</span>.$el = <span class="keyword">typeof</span> options.el === <span class="string">&#x27;string&#x27;</span> ? <span class="built_in">document</span>.querySelector(el) : el</span><br><span class="line">    <span class="comment">// 2. 负责把 data 注入到 Vue 实例 </span></span><br><span class="line">    <span class="built_in">this</span>._proxyData(<span class="built_in">this</span>.$data) </span><br><span class="line">    <span class="comment">// 3. 负责调用 Observer 实现数据劫持</span></span><br><span class="line">    <span class="keyword">new</span> Observer(<span class="built_in">this</span>.$data)</span><br><span class="line">    <span class="comment">// 4. 负责调用 Compiler 解析指令/插值表达式等 </span></span><br><span class="line">    <span class="keyword">new</span> Compiler(<span class="built_in">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  _proxyData (data) &#123; </span><br><span class="line">    <span class="comment">// 遍历 data 的所有属性 </span></span><br><span class="line">    <span class="built_in">Object</span>.keys(data).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123; </span><br><span class="line">      <span class="built_in">Object</span>.defineProperty(<span class="built_in">this</span>, key, &#123; </span><br><span class="line">        get () &#123; </span><br><span class="line">          <span class="keyword">return</span> data[key] </span><br><span class="line">        &#125;,</span><br><span class="line">        set (newValue) &#123; </span><br><span class="line">          <span class="keyword">if</span> (data[key] === newValue) &#123; </span><br><span class="line">            <span class="keyword">return</span> </span><br><span class="line">          &#125;</span><br><span class="line">          data[key] = newValue </span><br><span class="line">        &#125; </span><br><span class="line">      &#125;) </span><br><span class="line">    &#125;) </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Observer"><a href="#Observer" class="headerlink" title="Observer"></a>Observer</h3><ul><li><p>功能</p><ul><li><p>负责把 data 选项中的属性转换成响应式数据</p></li><li><p>data 中的某个属性也是对象，把该属性转换成响应式数据</p></li><li><p>数据变化发送通知</p></li></ul></li><li><p>结构</p><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20210423114811294.4fk7iw12om40.png" alt="image-20210423114811294"></p></li><li><p>代码</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 负责数据劫持 </span></span><br><span class="line"><span class="comment">// 把 $data 中的成员转换成 getter/setter </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123; </span><br><span class="line">  <span class="title">constructor</span> (<span class="params">data</span>) &#123; </span><br><span class="line">    <span class="built_in">this</span>.walk(data) </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 1. 判断数据是否是对象，如果不是对象返回 </span></span><br><span class="line">  <span class="comment">// 2. 如果是对象，遍历对象的所有属性，设置为 getter/setter </span></span><br><span class="line">  walk (data) &#123; </span><br><span class="line">    <span class="keyword">if</span> (!data || <span class="keyword">typeof</span> data !== <span class="string">&#x27;object&#x27;</span>) &#123; </span><br><span class="line">      <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历 data 的所有成员 </span></span><br><span class="line">    <span class="built_in">Object</span>.keys(data).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123; </span><br><span class="line">      <span class="built_in">this</span>.defineReactive(data, key, data[key]) </span><br><span class="line">    &#125;) </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 定义响应式成员 </span></span><br><span class="line">  defineReactive (data, key, val) &#123; </span><br><span class="line">    <span class="keyword">const</span> that = <span class="built_in">this</span> </span><br><span class="line">    <span class="comment">// 如果 val 是对象，继续设置它下面的成员为响应式数据 </span></span><br><span class="line">    <span class="built_in">this</span>.walk(val) </span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(data, key, &#123; </span><br><span class="line">      configurable: <span class="literal">true</span>, </span><br><span class="line">      enumerable: <span class="literal">true</span>, </span><br><span class="line">      get () &#123; </span><br><span class="line">        <span class="keyword">return</span> val </span><br><span class="line">      &#125;,</span><br><span class="line">      set (newValue) &#123; </span><br><span class="line">        <span class="keyword">if</span> (newValue === val) &#123; </span><br><span class="line">          <span class="keyword">return</span> </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果 newValue 是对象，设置 newValue 的成员为响应式 </span></span><br><span class="line">        that.walk(newValue) </span><br><span class="line">        val = newValue</span><br><span class="line">      &#125; </span><br><span class="line">    &#125;) </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Compiler"><a href="#Compiler" class="headerlink" title="Compiler"></a><strong>Compiler</strong></h3><ul><li><p>功能</p><ul><li>负责编译模板，解析指令/插值表达式</li><li>负责页面的首次渲染</li><li>当数据变化后重新渲染视图</li></ul></li><li><p>结构</p><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20210423115011695.41bi909abc80.png" alt="image-20210423115011695"></p></li><li><p>代码</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 负责解析指令/插值表达式 </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compiler</span> </span>&#123; </span><br><span class="line">  <span class="title">constructor</span> (<span class="params">vm</span>) &#123; </span><br><span class="line">    <span class="built_in">this</span>.vm = vm </span><br><span class="line">    <span class="built_in">this</span>.el = vm.$el</span><br><span class="line">    <span class="comment">// 编译模板 </span></span><br><span class="line">    <span class="built_in">this</span>.compile(<span class="built_in">this</span>.el) </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 编译模板 </span></span><br><span class="line">  <span class="comment">// 处理文本节点和元素节点 </span></span><br><span class="line">  compile (el) &#123; </span><br><span class="line">    <span class="keyword">const</span> nodes = el.childNodes </span><br><span class="line">    <span class="built_in">Array</span>.from(nodes).forEach(<span class="function"><span class="params">node</span> =&gt;</span> &#123; </span><br><span class="line">      <span class="comment">// 判断是文本节点还是元素节点 </span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.isTextNode(node)) &#123; </span><br><span class="line">        <span class="built_in">this</span>.compileText(node) </span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        <span class="built_in">this</span>.isElementNode(node)</span><br><span class="line">      ) &#123; </span><br><span class="line">        <span class="built_in">this</span>.compileElement(node) </span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (node.childNodes &amp;&amp; node.childNodes.length) &#123; </span><br><span class="line">        <span class="comment">// 如果当前节点中还有子节点，递归编译 </span></span><br><span class="line">        <span class="built_in">this</span>.compile(node) </span><br><span class="line">      &#125; </span><br><span class="line">    &#125;) </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 判断是否是文本节点 </span></span><br><span class="line">  isTextNode (node) &#123; </span><br><span class="line">    <span class="keyword">return</span> node.nodeType === <span class="number">3</span> </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 判断是否是属性节点 </span></span><br><span class="line">  isElementNode (node) &#123; </span><br><span class="line">    <span class="keyword">return</span> node.nodeType === <span class="number">1</span> </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 判断是否是以 v- 开头的指令 </span></span><br><span class="line">  isDirective (attrName) &#123; </span><br><span class="line">    <span class="keyword">return</span> attrName.startsWith(<span class="string">&#x27;v-&#x27;</span>) </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 编译文本节点 </span></span><br><span class="line">  compileText (node) &#123; &#125;</span><br><span class="line">  <span class="comment">// 编译属性节点 </span></span><br><span class="line">  compileElement (node) &#123; &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="compileText"><a href="#compileText" class="headerlink" title="compileText()"></a><strong>compileText()</strong></h4><ul><li>负责编译插值表达式</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译文本节点 </span></span><br><span class="line">compileText (node) &#123; </span><br><span class="line">  <span class="keyword">const</span> reg = <span class="regexp">/\&#123;\&#123;(.+)\&#125;\&#125;/</span> </span><br><span class="line">  <span class="comment">// 获取文本节点的内容 </span></span><br><span class="line">  <span class="keyword">const</span> value = node.textContent </span><br><span class="line">  <span class="keyword">if</span> (reg.test(value)) &#123; </span><br><span class="line">    <span class="comment">// 插值表达式中的值就是我们要的属性名称 </span></span><br><span class="line">    <span class="keyword">const</span> key = <span class="built_in">RegExp</span>.$1.trim() </span><br><span class="line">    <span class="comment">// 把插值表达式替换成具体的值 </span></span><br><span class="line">    node.textContent = value.replace(reg, <span class="built_in">this</span>.vm[key]) </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="compileElement"><a href="#compileElement" class="headerlink" title="compileElement()"></a><strong>compileElement()</strong></h4><ul><li><p>负责编译元素的指令</p></li><li><p>处理 v-text 的首次渲染</p></li><li><p>处理 v-model 的首次渲染</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译属性节点 </span></span><br><span class="line">compileElement (node) &#123; </span><br><span class="line">  <span class="comment">// 遍历元素节点中的所有属性，找到指令 </span></span><br><span class="line">  <span class="built_in">Array</span>.from(node.attributes).forEach(<span class="function"><span class="params">attr</span> =&gt;</span> &#123; </span><br><span class="line">    <span class="comment">// 获取元素属性的名称 </span></span><br><span class="line">    <span class="keyword">let</span> attrName = attr.name </span><br><span class="line">    <span class="comment">// 判断当前的属性名称是否是指令 </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.isDirective(attrName)) &#123; </span><br><span class="line">      <span class="comment">// attrName 的形式 v-text v-model </span></span><br><span class="line">      <span class="comment">// 截取属性的名称，获取 text model </span></span><br><span class="line">      attrName = attrName.substr(<span class="number">2</span>) </span><br><span class="line">      <span class="comment">// 获取属性的名称，属性的名称就是我们数据对象的属性 v-text=&quot;name&quot;，获取的是 name </span></span><br><span class="line">      <span class="keyword">const</span> key = attr.value </span><br><span class="line">      <span class="comment">// 处理不同的指令 </span></span><br><span class="line">      <span class="built_in">this</span>.update(node, key, attrName) </span><br><span class="line">    &#125; </span><br><span class="line">  &#125;) </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 负责更新 DOM </span></span><br><span class="line"><span class="comment">// 创建 Watcher </span></span><br><span class="line">update (node, key, dir) &#123; </span><br><span class="line">  <span class="comment">// node 节点，key 数据的属性名称，dir 指令的后半部分 </span></span><br><span class="line">  <span class="keyword">const</span> updaterFn = <span class="built_in">this</span>[dir + <span class="string">&#x27;Updater&#x27;</span>] </span><br><span class="line">  <span class="comment">// 处理 v-on 指令</span></span><br><span class="line">  <span class="keyword">if</span> (attrName.startsWith(<span class="string">&#x27;on:&#x27;</span>)) &#123;</span><br><span class="line">    updateFn = <span class="built_in">this</span>[<span class="string">&#x27;on&#x27;</span> + <span class="string">&#x27;Updater&#x27;</span>]</span><br><span class="line">    <span class="keyword">const</span> eventType = attrName.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">    updateFn.call(<span class="built_in">this</span>, node, <span class="built_in">this</span>.vm[key], key, eventType)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  updateFn &amp;&amp; updateFn.call(<span class="built_in">this</span>, node, <span class="built_in">this</span>.vm[key], key) <span class="comment">// 此处的 this 就是 compiler 对象 </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// v-text 指令的更新方法 </span></span><br><span class="line">textUpdater (node, value) &#123; </span><br><span class="line">  node.textContent = value </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// v-model 指令的更新方法 </span></span><br><span class="line">modelUpdater (node, value) &#123; </span><br><span class="line">  node.value = value </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// v-html 指令的更新方法</span></span><br><span class="line">htmlUpdater (node, value, key) &#123;</span><br><span class="line">  node.innerHTML = value</span><br><span class="line">  <span class="keyword">new</span> Watcher(<span class="built_in">this</span>.vm, key, <span class="function">(<span class="params">newValue</span>) =&gt;</span> &#123;</span><br><span class="line">    node.innerHTML = newValue</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 处理 v-on 指令</span></span><br><span class="line">onUpdater (node, value, key, eventType) &#123;</span><br><span class="line">  node.addEventListener(eventType, <span class="built_in">this</span>.vm.$options.methods[key])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Dep-Dependency"><a href="#Dep-Dependency" class="headerlink" title="Dep(Dependency)"></a><strong>Dep(Dependency)</strong></h3><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20210423120227165.qhxo1ewyjww.png" alt="image-20210423120227165"></p><ul><li><p>功能</p><ul><li>收集依赖，添加观察者(watcher)</li><li>通知所有观察者</li></ul></li><li><p>结构</p></li></ul><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20210423120405508.1q5piqjl6clc.png" alt="image-20210423120405508"></p><ul><li>代码</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123; </span><br><span class="line">  <span class="title">constructor</span> (<span class="params"></span>) &#123; </span><br><span class="line">    <span class="comment">// 存储所有的观察者 </span></span><br><span class="line">    <span class="built_in">this</span>.subs = [] </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 添加观察者 </span></span><br><span class="line">  addSub (sub) &#123; </span><br><span class="line">    <span class="keyword">if</span> (sub &amp;&amp; sub.update) &#123; </span><br><span class="line">      <span class="built_in">this</span>.subs.push(sub) </span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 通知所有观察者 </span></span><br><span class="line">  notify () &#123; </span><br><span class="line">    <span class="built_in">this</span>.subs.forEach(<span class="function"><span class="params">sub</span> =&gt;</span> &#123; </span><br><span class="line">      sub.update() </span><br><span class="line">    &#125;) </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>在 compiler.js 中收集依赖，发送通知</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// defineReactive 中 </span></span><br><span class="line"><span class="comment">// 创建 dep 对象收集依赖 </span></span><br><span class="line"><span class="keyword">const</span> dep = <span class="keyword">new</span> Dep() </span><br><span class="line"><span class="comment">// getter 中 </span></span><br><span class="line"><span class="comment">// get 的过程中收集依赖 </span></span><br><span class="line">Dep.target &amp;&amp; dep.addSub(Dep.target) </span><br><span class="line"><span class="comment">// setter 中 </span></span><br><span class="line"><span class="comment">// 当数据变化之后，发送通知 </span></span><br><span class="line">dep.notify()</span><br></pre></td></tr></table></figure><h3 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a><strong>Watcher</strong></h3><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20210423120906887.obnmlu04b3k.png" alt="image-20210423120906887"></p><ul><li><p>功能</p><ul><li>当数据变化触发依赖， dep 通知所有的 Watcher 实例更新视图</li><li>自身实例化的时候往 dep 对象中添加自己</li></ul></li><li><p>结构</p><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20210423121051348.36gxj5kmjzy0.png" alt="image-20210423121051348"></p></li><li><p>代码</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123; </span><br><span class="line">  <span class="title">constructor</span> (<span class="params">vm, key, cb</span>) &#123; </span><br><span class="line">    <span class="built_in">this</span>.vm = vm </span><br><span class="line">    <span class="comment">// data 中的属性名称 </span></span><br><span class="line">    <span class="built_in">this</span>.key = key </span><br><span class="line">    <span class="comment">// 当数据变化的时候，调用 cb 更新视图 </span></span><br><span class="line">    <span class="built_in">this</span>.cb = cb </span><br><span class="line">    <span class="comment">// 在 Dep 的静态属性上记录当前 watcher 对象，当访问数据的时候把 watcher 添加到 dep 的 subs 中 </span></span><br><span class="line">    Dep.target = <span class="built_in">this</span> </span><br><span class="line">    <span class="comment">// 触发一次 getter，让 dep 为当前 key 记录 watcher </span></span><br><span class="line">    <span class="built_in">this</span>.oldValue = vm[key] </span><br><span class="line">    <span class="comment">// 清空 target </span></span><br><span class="line">    Dep.target = <span class="literal">null</span> </span><br><span class="line">  &#125;</span><br><span class="line">  update () &#123; </span><br><span class="line">    <span class="keyword">const</span> newValue = <span class="built_in">this</span>.vm[<span class="built_in">this</span>.key] </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.oldValue === newValue) &#123; </span><br><span class="line">      <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.cb(newValue) </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>在 compiler.js 中为每一个指令/插值表达式创建 watcher 对象，监视数据的变化</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 因为在 textUpdater等中要使用 </span></span><br><span class="line"><span class="built_in">this</span> updaterFn &amp;&amp; updaterFn.call(<span class="built_in">this</span>, node, <span class="built_in">this</span>.vm[key], key) </span><br><span class="line"><span class="comment">// v-text 指令的更新方法 </span></span><br><span class="line">textUpdater (node, value, key) &#123; </span><br><span class="line">  node.textContent = value </span><br><span class="line">  <span class="comment">// 每一个指令中创建一个 watcher，观察数据的变化 </span></span><br><span class="line">  <span class="keyword">new</span> Watcher(<span class="built_in">this</span>.vm, key, <span class="function"><span class="params">value</span> =&gt;</span> &#123; </span><br><span class="line">    node.textContent = value </span><br><span class="line">  &#125;) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>视图变化更新数据</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v-model 指令的更新方法 </span></span><br><span class="line">modelUpdater (node, value, key) &#123; </span><br><span class="line">  node.value = value </span><br><span class="line">  <span class="comment">// 每一个指令中创建一个 watcher，观察数据的变化 </span></span><br><span class="line">  <span class="keyword">new</span> Watcher(<span class="built_in">this</span>.vm, key, <span class="function"><span class="params">value</span> =&gt;</span> &#123; </span><br><span class="line">    node.value = value </span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 监听视图的变化 </span></span><br><span class="line">  node.addEventListener(<span class="string">&#x27;input&#x27;</span>, <span class="function">() =&gt;</span> &#123; </span><br><span class="line">    <span class="built_in">this</span>.vm[key] = node.value </span><br><span class="line">  &#125;) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a><strong>总结</strong></h3><ul><li>通过下图回顾整体流程</li></ul><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20210423141500870.vbq2jhcfb9c.png" alt="image-20210423141500870"></p><ul><li><p>Vue</p><ul><li>记录传入的选项，设置 $data/$el</li><li>把 data 的成员注入到 Vue 实例</li><li>负责调用 Observer 实现数据响应式处理（数据劫持）</li><li>负责调用 Compiler 编译指令/插值表达式等</li></ul></li><li><p>Observer</p><ul><li>数据劫持<ul><li>负责把 data 中的成员转换成 getter/setter</li><li>负责把多层属性转换成 getter/setter</li><li>如果给属性赋值为新对象，把新对象的成员设置为 getter/setter</li></ul></li><li>添加 Dep 和 Watcher 的依赖关系</li><li>数据变化发送通知</li></ul></li><li><p>Compiler</p><ul><li>负责编译模板，解析指令/插值表达式</li><li>负责页面的首次渲染过程</li><li>当数据变化后重新渲染</li></ul></li><li><p>Dep</p><ul><li>收集依赖，添加订阅者(watcher)</li><li>通知所有订阅者</li></ul></li><li><p>Watcher</p><ul><li>自身实例化的时候往dep对象中添加自己</li><li>当数据变化dep通知所有的 Watcher 实例更新视图</li></ul></li></ul></div><div class="post-copyright-info"><div class="article-copyright-info-container"><ul><li>Post title：Vue响应式原理模拟</li><li>Post author：wkxk</li><li>Create time：2021-04-23 10:41:32</li><li>Post link：http://www.iwkxk.com/2021/04/23/Vue响应式原理模拟/</li><li>Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.</li></ul></div></div><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/2021/04/23/Snabbdom%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">Snabbdom深入剖析</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/2021/04/23/vue-router%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/"><span class="title flex-center"><span class="post-nav-title-item">vue-router的实现原理</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div><div class="comment-container"><div class="comments-container"><div id="comment-anchor"></div><div class="comment-area-title"><i class="fas fa-comments">&nbsp;Comments</i></div><div id="gitalk-container"></div><script data-pjax src="//cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script><script data-pjax>function loadGitalk(){let e=decodeURI(location.pathname);e.length>50&&(e=e.substring(0,47)+"...");try{Gitalk&&new Gitalk({clientID:"95ee2e163d7f20d8de19",clientSecret:"ad675c3bdff4af0fa754ab836be591c2e3aeb688",repo:"my-gitalk",owner:"wkxk",admin:["wkxk"],id:e,language:"zh"}).render("gitalk-container")}catch(e){window.Gitalk=null}}{const e=setTimeout(()=>{loadGitalk(),clearTimeout(e)},1e3)}</script></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2020</span>&nbsp;-&nbsp; 2021&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">wkxk</a></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item"><span id="busuanzi_container_site_uv">Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp; </span><span id="busuanzi_container_site_pv">Totalview&nbsp;<span id="busuanzi_value_site_pv"></span></span></div><div class="theme-info info-item">Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.2</a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item page-aside-toggle"><i class="fas fa-outdent"></i></li><li class="go-comment"><i class="fas fa-comment"></i></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-expand-width flex-center"><i class="fas fa-arrows-alt-h"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><aside class="page-aside"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">1.</span> <span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E9%A9%B1%E5%8A%A8"><span class="nav-number">2.</span> <span class="nav-text">数据驱动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94%E5%BC%8F%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="nav-number">3.</span> <span class="nav-text">数据响应式的核心原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Vue-2-x"><span class="nav-number">3.1.</span> <span class="nav-text">Vue 2.x</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Vue-3-x"><span class="nav-number">3.2.</span> <span class="nav-text">Vue 3.x</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F%E5%92%8C%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="nav-number">4.</span> <span class="nav-text">发布订阅模式和观察者模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83-%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="nav-number">4.1.</span> <span class="nav-text">发布&#x2F;订阅模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="nav-number">4.2.</span> <span class="nav-text">观察者模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">4.3.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vue-%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86%E6%A8%A1%E6%8B%9F"><span class="nav-number">5.</span> <span class="nav-text">Vue 响应式原理模拟</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E5%88%86%E6%9E%90"><span class="nav-number">5.1.</span> <span class="nav-text">整体分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Vue"><span class="nav-number">5.2.</span> <span class="nav-text">Vue</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Observer"><span class="nav-number">5.3.</span> <span class="nav-text">Observer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Compiler"><span class="nav-number">5.4.</span> <span class="nav-text">Compiler</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#compileText"><span class="nav-number">5.4.1.</span> <span class="nav-text">compileText()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#compileElement"><span class="nav-number">5.4.2.</span> <span class="nav-text">compileElement()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dep-Dependency"><span class="nav-number">5.5.</span> <span class="nav-text">Dep(Dependency)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Watcher"><span class="nav-number">5.6.</span> <span class="nav-text">Watcher</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-number">5.7.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div></div></aside><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/dark-light-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/local-search.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/code-copy.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/lazyload.js"></script><div class="post-scripts pjax"><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/toc.js"></script></div><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/libs/pjax.min.js"></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=new Pjax({selectors:["head title",".page-container",".pjax"],history:!0,debug:!1,cacheBust:!1,timeout:0,analytics:!1,currentUrlFullReload:!1,scrollRestoration:!1});document.addEventListener("pjax:send",()=>{KEEP.utils.pjaxProgressBarStart()}),document.addEventListener("pjax:complete",()=>{KEEP.utils.pjaxProgressBarEnd(),e.executeScripts(document.querySelectorAll("script[data-pjax], .pjax script")),KEEP.refresh()})})</script></body></html>