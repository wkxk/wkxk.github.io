<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="JavaScript,Vue2,Vue3,Vite,Webpack,node"><meta name="description" content="wkxk的个人博客，主要涉及到编程(JavaScript,Vue2,Vue3,Webpack,node),助于个人学习提升，分享学习过程"><meta name="author" content="wkxk"><title>Snabbdom深入剖析 | wkxk&#39;s Blog</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/logo.7kmeykeizco0.svg"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/css/font-awesome.min.css"><script id="hexo-configurations">let KEEP=window.KEEP||{};KEEP.hexo_config={hostname:"www.iwkxk.com",root:"/",language:"zh",path:"search.xml"},KEEP.theme_config={toc:{enable:!0,number:!0,expand_all:!0,init_open:!0},style:{primary_color:"#0066CC",avatar:"https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/avator.2use3mem6940.svg",favicon:"https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/logo.7kmeykeizco0.svg",article_img_align:"left",left_side_width:"260px",content_max_width:"920px",hover:{shadow:!0,scale:!0},first_screen:{enable:!0,background_img:"/images/bg.svg",description:"愿你眼里有光，眼底无霜，心有大海，胸无睚眦。风尘自仆仆，你我当归人。"},scroll:{progress_bar:{enable:!0},percent:{enable:!0}}},local_search:{enable:!0,preload:!0},code_copy:{enable:!0,style:"default"},pjax:{enable:!0},lazyload:{enable:!0},version:"3.4.2"},KEEP.language_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"}</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="progress-bar-container"><span class="scroll-progress-bar"></span> <span class="pjax-progress-bar"></span> <span class="pjax-progress-icon"><i class="fas fa-circle-notch fa-spin"></i></span></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-title" href="/">wkxk&#39;s Blog</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">HOME</a></li><li class="menu-item"><a href="/archives">ARCHIVES</a></li><li class="menu-item"><a href="/links">LINKS</a></li><li class="menu-item"><a href="/about">ABOUT</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">HOME</a></li><li class="drawer-menu-item flex-center"><a href="/archives">ARCHIVES</a></li><li class="drawer-menu-item flex-center"><a href="/links">LINKS</a></li><li class="drawer-menu-item flex-center"><a href="/about">ABOUT</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">Snabbdom深入剖析</span></div><div class="article-header"><div class="avatar"><img src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/avator.2use3mem6940.svg"></div><div class="info"><div class="author"><span class="name">wkxk</span> <span class="author-label">前端攻城狮</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fas fa-edit"></i>&nbsp;2021-04-23 14:37:25 </span><span class="article-categories article-meta-item"><i class="fas fa-folder"></i>&nbsp;<ul><li><a href="/categories/Vue%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90/">Vue原理剖析</a>&nbsp;</li></ul></span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/Snabbdom/">Snabbdom</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>6.7k Words</span> </span><span class="article-min2read article-meta-item"><i class="fas fa-clock"></i>&nbsp;<span>30 Mins</span> </span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body"><h2 id="什么是-Virtual-DOM"><a href="#什么是-Virtual-DOM" class="headerlink" title="什么是 Virtual DOM"></a>什么是 Virtual DOM</h2><ul><li><p>**Virtual DOM(虚拟 DOM)**，是由普通的 JS 对象来描述 DOM 对象，因为不是真实的 DOM 对象，所以叫 Virtual DOM</p></li><li><p>真实 DOM 成员</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> element = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> s = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> element) &#123;</span><br><span class="line">  s += key + <span class="string">&#x27;,&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(s)</span><br></pre></td></tr></table></figure></li><li><p>可以使用 Virtual DOM 来描述真实 DOM，示例</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  sel: <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  data: &#123;&#125;,</span><br><span class="line">  children: <span class="literal">undefined</span>,</span><br><span class="line">  text: <span class="string">&quot;Hello Virtual DOM&quot;</span>,</span><br><span class="line">  elm: <span class="literal">undefined</span>,</span><br><span class="line">  key: <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="为什么使用-Virtual-DOM"><a href="#为什么使用-Virtual-DOM" class="headerlink" title="为什么使用 Virtual DOM"></a>为什么使用 Virtual DOM</h2><ul><li>手动操作 DOM 比较麻烦，还需要考虑浏览器兼容性问题，虽然有 jQuery 等库简化 DOM 操作，但是随着项目的复杂 DOM 操作复杂提升</li><li>为了简化 DOM 的复杂操作于是出现了各种 MVVM 框架，MVVM 框架解决了视图和状态的同步问题</li><li>为了简化视图的操作我们可以使用模板引擎，但是模板引擎没有解决跟踪状态变化的问题，于是 Virtual DOM 出现了</li><li>Virtual DOM 的好处是当状态改变时不需要立即更新 DOM，只需要创建一个虚拟树来描述 DOM， Virtual DOM 内部将弄清楚如何有效(diff)的更新 DOM</li><li>参考 github 上 <a class="link" target="_blank" rel="noopener" href="https://github.com/Matt-Esch/virtual-dom">virtual-dom<i class="fas fa-external-link-alt"></i></a> 的描述<ul><li>虚拟 DOM 可以维护程序的状态，跟踪上一次的状态</li><li>通过比较前后两次状态的差异更新真实 DOM</li></ul></li></ul><h2 id="虚拟-DOM-的作用"><a href="#虚拟-DOM-的作用" class="headerlink" title="虚拟 DOM 的作用"></a>虚拟 DOM 的作用</h2><ul><li><p>维护视图和状态的关系</p></li><li><p>复杂视图情况下提升渲染性能</p></li><li><p>除了渲染 DOM 以外，还可以实现 SSR(Nuxt.js/Next.js)、原生应用(Weex/React Native)、小程序(mpvue/uni-app)等</p><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20200102104642121.28drvtzb97rw.png" alt="image-20200102104642121"></p></li></ul><h2 id="Virtual-DOM-库"><a href="#Virtual-DOM-库" class="headerlink" title="Virtual DOM 库"></a>Virtual DOM 库</h2><ul><li><p><a class="link" target="_blank" rel="noopener" href="https://github.com/snabbdom/snabbdom">Snabbdom<i class="fas fa-external-link-alt"></i></a></p><ul><li>Vue 2.x 内部使用的 Virtual DOM 就是改造的 Snabbdom</li><li>大约 200 SLOC（single line of code）</li><li>通过模块可扩展</li><li>源码使用 TypeScript 开发</li><li>最快的 Virtual DOM 之一</li></ul></li><li><p><a class="link" target="_blank" rel="noopener" href="https://github.com/Matt-Esch/virtual-dom">virtual-dom<i class="fas fa-external-link-alt"></i></a></p><h2 id="案例演示"><a href="#案例演示" class="headerlink" title="案例演示"></a>案例演示</h2><ul><li><a class="link" target="_blank" rel="noopener" href="https://codesandbox.io/s/jq-demo-5i7qp">jQuery-demo<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" target="_blank" rel="noopener" href="https://codesandbox.io/s/snabbdom-demo-4hbyb">snabbdom-demo<i class="fas fa-external-link-alt"></i></a></li></ul></li></ul><h1 id="Snabbdom-基本使用"><a href="#Snabbdom-基本使用" class="headerlink" title="Snabbdom 基本使用"></a>Snabbdom 基本使用</h1><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><ul><li><p>打包工具为了方便使用 <a class="link" target="_blank" rel="noopener" href="https://parceljs.org/getting_started.html">parcel<i class="fas fa-external-link-alt"></i></a></p></li><li><p>创建项目，并安装 <a class="link" target="_blank" rel="noopener" href="https://parceljs.org/getting_started.html">parcel<i class="fas fa-external-link-alt"></i></a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建项目目录</span></span><br><span class="line">md snabbdom-demo</span><br><span class="line"><span class="comment"># 进入项目目录</span></span><br><span class="line"><span class="built_in">cd</span> snabbdom-demo</span><br><span class="line"><span class="comment"># 创建 package.json</span></span><br><span class="line">npm init -y</span><br><span class="line"><span class="comment"># 本地安装 parcel</span></span><br><span class="line">npm install parcel-bundler -D</span><br></pre></td></tr></table></figure></li><li><p>配置 package.json 的 scripts</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;dev&quot;</span>: <span class="string">&quot;parcel index.html --open&quot;</span>,</span><br><span class="line">  <span class="string">&quot;build&quot;</span>: <span class="string">&quot;parcel build index.html&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建目录结构</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">│  index.html</span><br><span class="line">│  package.json</span><br><span class="line">└─src</span><br><span class="line">		<span class="number">01</span>-basicusage.js</span><br></pre></td></tr></table></figure></li></ul><h2 id="导入-Snabbdom"><a href="#导入-Snabbdom" class="headerlink" title="导入 Snabbdom"></a>导入 Snabbdom</h2><h2 id="Snabbdom-文档"><a href="#Snabbdom-文档" class="headerlink" title="Snabbdom 文档"></a>Snabbdom 文档</h2><ul><li><p>看文档的意义</p><ul><li>学习任何一个库都要先看文档</li><li>通过文档了解库的作用</li><li>看文档中提供的示例，自己快速实现一个 demo</li><li>通过文档查看 API 的使用</li></ul></li><li><p>文档地址</p><ul><li><a class="link" target="_blank" rel="noopener" href="https://github.com/snabbdom/snabbdom">https://github.com/snabbdom/snabbdom<i class="fas fa-external-link-alt"></i></a></li><li>当前版本 v2.1.0</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># --depth 表示克隆深度, 1 表示只克隆最新的版本. 因为如果项目迭代的版本很多, 克隆会很慢</span><br><span class="line">git clone -b v2.1.0 --depth&#x3D;1 https:&#x2F;&#x2F;github.com&#x2F;snabbdom&#x2F;snabbdom.git</span><br></pre></td></tr></table></figure></li></ul><h3 id="安装-Snabbdom"><a href="#安装-Snabbdom" class="headerlink" title="安装  Snabbdom"></a>安装 Snabbdom</h3><ul><li><p>安装 Snabbdom</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install snabbdom@2.1.0</span><br></pre></td></tr></table></figure></li></ul><h3 id="导入-Snabbdom-1"><a href="#导入-Snabbdom-1" class="headerlink" title="导入  Snabbdom"></a>导入 Snabbdom</h3><ul><li>Snabbdom 的两个核心函数 init 和 h()<ul><li>init() 是一个高阶函数，返回 patch()</li><li>h() 返回虚拟节点 VNode，这个函数我们在使用 Vue.js 的时候见过</li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; init &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/init&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/h&#x27;</span></span><br><span class="line"><span class="keyword">const</span> patch = init([])</span><br></pre></td></tr></table></figure><blockquote><p>注意：此时运行的话会告诉我们找不到 init / h 模块，因为模块路径并不是 snabbdom/int，这个路径是在 package.json 中的 exports 字段设置的，而我们使用的打包工具不支持 exports 这个字段，webpack 4 也不支持，webpack 5 支持该字段。该字段在导入 snabbdom/init 的时候会补全路径成 snabbdom/build/package/init.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;exports&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;./init&quot;</span>: <span class="string">&quot;./build/package/init.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./h&quot;</span>: <span class="string">&quot;./build/package/h.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./helpers/attachto&quot;</span>: <span class="string">&quot;./build/package/helpers/attachto.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./hooks&quot;</span>: <span class="string">&quot;./build/package/hooks.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./htmldomapi&quot;</span>: <span class="string">&quot;./build/package/htmldomapi.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./is&quot;</span>: <span class="string">&quot;./build/package/is.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./jsx&quot;</span>: <span class="string">&quot;./build/package/jsx.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./modules/attributes&quot;</span>: <span class="string">&quot;./build/package/modules/attributes.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./modules/class&quot;</span>: <span class="string">&quot;./build/package/modules/class.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./modules/dataset&quot;</span>: <span class="string">&quot;./build/package/modules/dataset.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./modules/eventlisteners&quot;</span>: <span class="string">&quot;./build/package/modules/eventlisteners.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./modules/hero&quot;</span>: <span class="string">&quot;./build/package/modules/hero.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./modules/module&quot;</span>: <span class="string">&quot;./build/package/modules/module.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./modules/props&quot;</span>: <span class="string">&quot;./build/package/modules/props.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./modules/style&quot;</span>: <span class="string">&quot;./build/package/modules/style.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./thunk&quot;</span>: <span class="string">&quot;./build/package/thunk.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./tovnode&quot;</span>: <span class="string">&quot;./build/package/tovnode.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./vnode&quot;</span>: <span class="string">&quot;./build/package/vnode.js&quot;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ul><li>如果使用不支持 package.json 的 exports 字段的打包工具，我们应该把模块的路径写全<ul><li>查看安装的 snabbdom 的目录结构</li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/build/package/h&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; init &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/build/package/init&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; classModule &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/build/package/modules/class&#x27;</span></span><br></pre></td></tr></table></figure><ul><li>回顾 Vue 中的 render 函数</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  router,</span><br><span class="line">  store,</span><br><span class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</span><br><span class="line">&#125;).$mount(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure><ul><li>thunk() 是一种优化策略，可以在处理不可变数据时使用</li></ul><h2 id="代码演示"><a href="#代码演示" class="headerlink" title="代码演示"></a>代码演示</h2><h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/build/package/h&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; init &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/build/package/init&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 init() 函数创建 patch()</span></span><br><span class="line"><span class="comment">// init() 的参数是数组，将来可以传入模块，处理属性/样式/事件等</span></span><br><span class="line"><span class="keyword">let</span> patch = init([])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 h() 函数创建 vnode</span></span><br><span class="line"><span class="keyword">let</span> vnode = h(<span class="string">&#x27;div.cls&#x27;</span>, [</span><br><span class="line">  h(<span class="string">&#x27;h1&#x27;</span>, <span class="string">&#x27;Hello Snabbdom&#x27;</span>),</span><br><span class="line">  h(<span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;这是段落&#x27;</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"><span class="comment">// 把 vnode 渲染到空的 DOM 元素（替换）</span></span><br><span class="line"><span class="comment">// 会返回新的 vnode</span></span><br><span class="line"><span class="keyword">let</span> oldVnode = patch(app, vnode)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  vnode = h(<span class="string">&#x27;div.cls&#x27;</span>, [</span><br><span class="line">    h(<span class="string">&#x27;h1&#x27;</span>, <span class="string">&#x27;Hello World&#x27;</span>),</span><br><span class="line">    h(<span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;这是段落&#x27;</span>)</span><br><span class="line">  ])</span><br><span class="line">  <span class="comment">// 把老的视图更新到新的状态</span></span><br><span class="line">  oldVnode = patch(oldVnode, vnode)</span><br><span class="line">  <span class="comment">// h(&#x27;!&#x27;) 是创建注释</span></span><br><span class="line">  patch(oldVnode, h(<span class="string">&#x27;!&#x27;</span>))</span><br><span class="line">&#125;, <span class="number">2000</span>)</span><br></pre></td></tr></table></figure><h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><p>Snabbdom 的核心库并不能处理 DOM 元素的属性/样式/事件等，如果需要处理的话，可以使用模块</p><h3 id="常用模块"><a href="#常用模块" class="headerlink" title="常用模块"></a>常用模块</h3><ul><li>官方提供了 6 个模块<ul><li>attributes<ul><li>设置 DOM 元素的属性，使用 <code>setAttribute</code>()</li><li>处理布尔类型的属性</li></ul></li><li>props<ul><li>和 <code>attributes</code> 模块相似，设置 DOM 元素的属性 <code>element[attr] = value</code></li><li>不处理布尔类型的属性</li></ul></li><li>class<ul><li>切换类样式</li><li>注意：给元素设置类样式是通过 <code>sel</code> 选择器</li></ul></li><li>dataset<ul><li>设置 <code>data-*</code> 的自定义属性</li></ul></li><li>eventlisteners<ul><li>注册和移除事件</li></ul></li><li>style<ul><li>设置行内样式，支持动画</li><li>delayed/remove/destroy</li></ul></li></ul></li></ul><h3 id="模块使用"><a href="#模块使用" class="headerlink" title="模块使用"></a>模块使用</h3><ul><li>模块使用步骤：<ul><li>导入需要的模块</li><li>init() 中注册模块</li><li>使用 h() 函数创建 VNode 的时候，可以把第二个参数设置为对象，其他参数往后移</li></ul></li></ul><h3 id="代码演示-1"><a href="#代码演示-1" class="headerlink" title="代码演示"></a>代码演示</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/build/package/h&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; init &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/build/package/init&#x27;</span></span><br><span class="line"><span class="comment">// 导入需要的模块</span></span><br><span class="line"><span class="keyword">import</span> &#123; styleModule &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/build/package/modules/style&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; eventListenersModule &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/build/package/modules/eventlisteners&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 init() 函数创建 patch()</span></span><br><span class="line"><span class="comment">// init() 的参数是数组，将来可以传入模块，处理属性/样式/事件等</span></span><br><span class="line"><span class="keyword">let</span> patch = init([</span><br><span class="line">  <span class="comment">// 注册模块</span></span><br><span class="line">  styleModule,</span><br><span class="line">  eventListenersModule</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 h() 函数创建 vnode</span></span><br><span class="line"><span class="keyword">let</span> vnode = h(<span class="string">&#x27;div.cls&#x27;</span>, &#123;</span><br><span class="line">  <span class="comment">// 设置 DOM 元素的行内样式</span></span><br><span class="line">  style: &#123; <span class="attr">color</span>: <span class="string">&#x27;#DEDEDE&#x27;</span>, <span class="attr">backgroundColor</span>: <span class="string">&#x27;#181A1B&#x27;</span> &#125;,</span><br><span class="line">  <span class="comment">// 注册事件</span></span><br><span class="line">  on: &#123; <span class="attr">click</span>: clickHandler &#125;</span><br><span class="line">&#125;, [</span><br><span class="line">  h(<span class="string">&#x27;h1&#x27;</span>, <span class="string">&#x27;Hello Snabbdom&#x27;</span>),</span><br><span class="line">  h(<span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;这是段落&#x27;</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clickHandler</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 此处的 this 指向对应的 vnode</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="built_in">this</span>.elm.innerHTML)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Snabbdom-源码解析"><a href="#Snabbdom-源码解析" class="headerlink" title="Snabbdom 源码解析"></a>Snabbdom 源码解析</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="如何学习源码"><a href="#如何学习源码" class="headerlink" title="如何学习源码"></a>如何学习源码</h3><ul><li>先宏观了解</li><li>带着目标看源码</li><li>看源码的过程要不求甚解</li><li>调试</li><li>参考资料</li></ul><h3 id="Snabbdom-的核心"><a href="#Snabbdom-的核心" class="headerlink" title="Snabbdom 的核心"></a>Snabbdom 的核心</h3><ul><li>使用 h() 函数创建 JavaScript 对象(VNode)描述真实 DOM</li><li>init() 设置模块，创建 patch()</li><li>patch() 比较新旧两个 VNode</li><li>把变化的内容更新到真实 DOM 树上</li></ul><h3 id="Snabbdom-源码"><a href="#Snabbdom-源码" class="headerlink" title="Snabbdom 源码"></a>Snabbdom 源码</h3><ul><li><p>源码地址：</p><ul><li><a class="link" target="_blank" rel="noopener" href="https://github.com/snabbdom/snabbdom">https://github.com/snabbdom/snabbdom<i class="fas fa-external-link-alt"></i></a></li></ul></li><li><p>src 目录结构</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">├── package</span><br><span class="line">│   ├── helpers</span><br><span class="line">│   │   └── attachto.ts   定义了 vnode.ts 中 AttachData 的数据结构</span><br><span class="line">│   ├── modules</span><br><span class="line">│   │   ├── attributes.ts</span><br><span class="line">│   │   ├── class.ts</span><br><span class="line">│   │   ├── dataset.ts</span><br><span class="line">│   │   ├── eventlisteners.ts</span><br><span class="line">│   │   ├── hero.ts       example 中使用到的自定义钩子</span><br><span class="line">│   │   ├── module.ts     定义了模块中用到的钩子函数</span><br><span class="line">│   │   ├── props.ts</span><br><span class="line">│   │   └── style.ts</span><br><span class="line">│   ├── h.ts              h() 函数，用来创建 VNode</span><br><span class="line">│   ├── hooks.ts          所有钩子函数的定义</span><br><span class="line">│   ├── htmldomapi.ts     对 DOM API 的包装</span><br><span class="line">│   ├── init.ts           加载 modules、DOMAPI，返回 patch 函数</span><br><span class="line">│   ├── is.ts             判断数组和原始值的函数</span><br><span class="line">│   ├── jsx-global.ts     jsx 的类型声明文件</span><br><span class="line">│   ├── jsx.ts            处理 jsx</span><br><span class="line">│   ├── thunk.ts          优化处理，对复杂视图不可变值得优化</span><br><span class="line">│   ├── tovnode.ts        DOM 转换成 VNode</span><br><span class="line">│   ├── ts-transform-js-extension.cjs</span><br><span class="line">│   ├── tsconfig.json     ts 的编译配置文件</span><br><span class="line">│   └── vnode.ts          虚拟节点定义</span><br></pre></td></tr></table></figure></li></ul><h2 id="h-函数"><a href="#h-函数" class="headerlink" title="h 函数"></a>h 函数</h2><ul><li><p>h() 函数介绍</p><ul><li><p>在使用 Vue 的时候见过 h() 函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">new Vue(&#123;</span><br><span class="line">  router,</span><br><span class="line">  store,</span><br><span class="line">  render: h &#x3D;&gt; h(App)</span><br><span class="line">&#125;).$mount(&#39;#app&#39;)</span><br></pre></td></tr></table></figure></li><li><p>h() 函数最早见于 <a class="link" target="_blank" rel="noopener" href="https://github.com/hyperhype/hyperscript">hyperscript<i class="fas fa-external-link-alt"></i></a>，使用 JavaScript 创建超文本</p></li><li><p>Snabbdom 中的 h() 函数不是用来创建超文本，而是创建 VNode</p></li></ul></li><li><p>函数重载</p><ul><li><p>概念</p><ul><li><strong>参数个数</strong>或<strong>类型</strong>不同的函数</li><li>JavaScript 中没有重载的概念</li><li>TypeScript 中有重载，不过重载的实现还是通过代码调整参数</li></ul></li><li><p>重载的示意</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span> (<span class="params">a: number, b: number</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a + b)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span> (<span class="params">a: number, b: number, c: number</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a + b + c)</span><br><span class="line">&#125;</span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span> (<span class="params">a: number, b: number</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a + b)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span> (<span class="params">a: number, b: string</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a + b)</span><br><span class="line">&#125;</span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="string">&#x27;2&#x27;</span>)</span><br></pre></td></tr></table></figure></li></ul></li><li><p>源码位置：src/package/h.ts</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// h 函数的重载</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">h</span> (<span class="params">sel: string</span>): <span class="title">VNode</span></span></span><br><span class="line"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">h</span> (<span class="params">sel: string, data: VNodeData | <span class="literal">null</span></span>): <span class="title">VNode</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">h</span> (<span class="params">sel: string, children: VNodeChildren</span>): <span class="title">VNode</span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">h</span> (<span class="params">sel: string, data: VNodeData | <span class="literal">null</span>, children: VNodeChildren</span>): <span class="title">VNode</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">h</span> (<span class="params">sel: any, b?: any, c?: any</span>): <span class="title">VNode</span> </span>&#123;</span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">var</span> <span class="title">data</span>: <span class="title">VNodeData</span> = </span>&#123;&#125;</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">  <span class="title">var</span> <span class="title">children</span>: <span class="title">any</span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">  <span class="title">var</span> <span class="title">text</span>: <span class="title">any</span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">  <span class="title">var</span> <span class="title">i</span>: <span class="title">number</span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">  // 处理参数，实现重载的机制</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">  <span class="title">if</span> (<span class="params">c !== <span class="literal">undefined</span></span>) </span>&#123;</span></span></span><br><span class="line"><span class="function"><span class="function">    // 处理三个参数的情况</span></span></span><br><span class="line"><span class="function"><span class="function">    // <span class="title">sel</span>、<span class="title">data</span>、<span class="title">children</span>/<span class="title">text</span></span></span></span><br><span class="line"><span class="function"><span class="function">    <span class="title">if</span> (<span class="params">b !== <span class="literal">null</span></span>) </span>&#123;</span></span><br><span class="line"><span class="function">      <span class="title">data</span> = <span class="title">b</span></span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">    <span class="title">if</span> (<span class="params">is.array(c)</span>) </span>&#123;</span><br><span class="line">      children = c</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (is.primitive(c)) &#123;</span><br><span class="line">      text = c</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c &amp;&amp; c.sel) &#123;</span><br><span class="line">      children = [c]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (b !== <span class="literal">undefined</span> &amp;&amp; b !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (is.array(b)) &#123;</span><br><span class="line">      children = b</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (is.primitive(b)) &#123;</span><br><span class="line">      <span class="comment">// 如果 c 是字符串或者数字</span></span><br><span class="line">      text = b</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (b &amp;&amp; b.sel) &#123;</span><br><span class="line">      <span class="comment">// 如果 b 是 VNode</span></span><br><span class="line">      children = [b]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; data = b &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (children !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="comment">// 处理 children 中的原始值(string/number)</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; children.length; ++i) &#123;</span><br><span class="line">      <span class="comment">// 如果 child 是 string/number，创建文本节点</span></span><br><span class="line">      <span class="keyword">if</span> (is.primitive(children[i])) children[i] = vnode(<span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">undefined</span>, children[i], <span class="literal">undefined</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    sel[<span class="number">0</span>] === <span class="string">&#x27;s&#x27;</span> &amp;&amp; sel[<span class="number">1</span>] === <span class="string">&#x27;v&#x27;</span> &amp;&amp; sel[<span class="number">2</span>] === <span class="string">&#x27;g&#x27;</span> &amp;&amp;</span><br><span class="line">    (sel.length === <span class="number">3</span> || sel[<span class="number">3</span>] === <span class="string">&#x27;.&#x27;</span> || sel[<span class="number">3</span>] === <span class="string">&#x27;#&#x27;</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 如果是 svg，添加命名空间</span></span><br><span class="line">    addNS(data, children, sel)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 返回 VNode</span></span><br><span class="line">  <span class="keyword">return</span> vnode(sel, data, children, text, <span class="literal">undefined</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul><h2 id="VNode"><a href="#VNode" class="headerlink" title="VNode"></a>VNode</h2><ul><li>一个 VNode 就是一个虚拟节点用来描述一个 DOM 元素，如果这个 VNode 有 children 就是 Virtual DOM</li><li>源码位置：src/package/vnode.ts</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> interface VNode &#123;</span><br><span class="line">  <span class="comment">// 选择器</span></span><br><span class="line">  sel: string | <span class="literal">undefined</span>;</span><br><span class="line">  <span class="comment">// 节点数据：属性/样式/事件等</span></span><br><span class="line">  data: VNodeData | <span class="literal">undefined</span>;</span><br><span class="line">  <span class="comment">// 子节点，和 text 只能互斥</span></span><br><span class="line">  children: <span class="built_in">Array</span>&lt;VNode | string&gt; | <span class="literal">undefined</span>;</span><br><span class="line">  <span class="comment">// 记录 vnode 对应的真实 DOM</span></span><br><span class="line">  elm: Node | <span class="literal">undefined</span>;</span><br><span class="line">  <span class="comment">// 节点中的内容，和 children 只能互斥</span></span><br><span class="line">  text: string | <span class="literal">undefined</span>;</span><br><span class="line">  <span class="comment">// 优化用</span></span><br><span class="line">  key: Key | <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">vnode</span> (<span class="params">sel: string | <span class="literal">undefined</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                      data: any | <span class="literal">undefined</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                      children: <span class="built_in">Array</span>&lt;VNode | string&gt; | <span class="literal">undefined</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                      text: string | <span class="literal">undefined</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                      elm: Element | Text | <span class="literal">undefined</span></span>): <span class="title">VNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = data === <span class="literal">undefined</span> ? <span class="literal">undefined</span> : data.key</span><br><span class="line">  <span class="keyword">return</span> &#123; sel, data, children, text, elm, key &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="snabbdom"><a href="#snabbdom" class="headerlink" title="snabbdom"></a>snabbdom</h2><ul><li>patch(oldVnode, newVnode)</li><li>打补丁，把新节点中变化的内容渲染到真实 DOM，最后返回新节点作为下一次处理的旧节点</li><li>对比新旧 VNode 是否相同节点(节点的 key 和 sel 相同)</li><li>如果不是相同节点，删除之前的内容，重新渲染</li><li>如果是相同节点，再判断新的 VNode 是否有 text，如果有并且和 oldVnode 的 text 不同，直接更新文本内容</li><li>如果新的 VNode 有 children，判断子节点是否有变化，判断子节点的过程使用的就是 diff 算法</li><li>diff 过程只进行同层级比较</li></ul><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20200102103653779.2xk8fi4x8tg0.png" alt="image-20200102103653779"></p><h3 id="init"><a href="#init" class="headerlink" title="init"></a>init</h3><ul><li><p><strong>功能：</strong>init(modules, domApi)，返回 patch() 函数（高阶函数）</p></li><li><p>为什么要使用高阶函数？</p><ul><li>因为 patch() 函数再外部会调用多次，每次调用依赖一些参数，比如：modules/domApi/cbs</li><li>通过高阶函数让 init() 内部形成闭包，返回的 patch() 可以访问到 modules/domApi/cbs，而不需要重新创建</li></ul></li><li><p>init() 在返回 patch() 之前，首先收集了所有模块中的钩子函数存储到 cbs 对象中</p></li><li><p>源码位置：src/package/init.ts</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hooks: <span class="built_in">Array</span>&lt;keyof Module&gt; = [<span class="string">&#x27;create&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;remove&#x27;</span>, <span class="string">&#x27;destroy&#x27;</span>, <span class="string">&#x27;pre&#x27;</span>, <span class="string">&#x27;post&#x27;</span>]</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span> (<span class="params">modules: <span class="built_in">Array</span>&lt;Partial&lt;Module&gt;&gt;, domApi?: DOMAPI</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i: number</span><br><span class="line">  <span class="keyword">let</span> j: number</span><br><span class="line">  <span class="keyword">const</span> cbs: ModuleHooks = &#123;</span><br><span class="line">    create: [],</span><br><span class="line">    update: [],</span><br><span class="line">    remove: [],</span><br><span class="line">    destroy: [],</span><br><span class="line">    pre: [],</span><br><span class="line">    post: []</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 初始化 api</span></span><br><span class="line">  <span class="keyword">const</span> api: DOMAPI = domApi !== <span class="literal">undefined</span> ? domApi : htmlDomApi</span><br><span class="line">  <span class="comment">// 把传入的所有模块的钩子方法，统一存储到 cbs 对象中</span></span><br><span class="line">  <span class="comment">// 最终构建的 cbs 对象的形式 cbs = [ create: [fn1, fn2], update: [], ... ]</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; hooks.length; ++i) &#123;</span><br><span class="line">    <span class="comment">// cbs[&#x27;create&#x27;] = []</span></span><br><span class="line">    cbs[hooks[i]] = []</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; modules.length; ++j) &#123;</span><br><span class="line">      <span class="comment">// const hook = modules[0][&#x27;create&#x27;]</span></span><br><span class="line">      <span class="keyword">const</span> hook = modules[j][hooks[i]]</span><br><span class="line">      <span class="keyword">if</span> (hook !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">        (cbs[hooks[i]] <span class="keyword">as</span> any[]).push(hook)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ……</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">patch</span> (<span class="params">oldVnode: VNode | Element, vnode: VNode</span>): <span class="title">VNode</span> </span>&#123;</span><br><span class="line">    ……</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h3><ul><li><p><strong>功能：</strong></p><ul><li>传入新旧 VNode，对比差异，把差异渲染到 DOM</li><li>返回新的 VNode，作为下一次 patch() 的 oldVnode</li></ul></li><li><p><strong>执行过程：</strong></p><ul><li>首先执行<strong>模块</strong>中的<strong>钩子</strong>函数 <code>pre</code></li><li>如果 oldVnode 和 vnode 相同（key 和 sel 相同）<ul><li>调用 patchVnode()，找节点的差异并更新 DOM</li></ul></li><li>如果 oldVnode 是 DOM 元素<ul><li>把 DOM 元素转换成 oldVnode</li><li>调用 createElm() 把 vnode 转换为真实 DOM，记录到 vnode.elm</li><li>把刚创建的 DOM 元素插入到 parent 中</li><li>移除老节点</li><li>触发<strong>用户</strong>设置的 <code>create</code> <strong>钩子</strong>函数</li></ul></li></ul></li><li><p>源码位置：src/package/init.ts</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">patch</span> (<span class="params">oldVnode: VNode | Element, vnode: VNode</span>): <span class="title">VNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i: number, <span class="attr">elm</span>: Node, <span class="attr">parent</span>: Node</span><br><span class="line">  <span class="comment">// 保存新插入节点的队列，为了触发钩子函数</span></span><br><span class="line">  <span class="keyword">const</span> insertedVnodeQueue: VNodeQueue = []</span><br><span class="line">  <span class="comment">// 执行模块的 pre 钩子函数</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.pre.length; ++i) cbs.pre[i]()</span><br><span class="line">  <span class="comment">// 如果 oldVnode 不是 VNode，创建 VNode 并设置 elm </span></span><br><span class="line">  <span class="keyword">if</span> (!isVnode(oldVnode)) &#123;</span><br><span class="line">    <span class="comment">// 把 DOM 元素转换成空的 VNode</span></span><br><span class="line">    oldVnode = emptyNodeAt(oldVnode)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果新旧节点是相同节点(key 和 sel 相同)</span></span><br><span class="line">  <span class="keyword">if</span> (sameVnode(oldVnode, vnode)) &#123;</span><br><span class="line">    <span class="comment">// 找节点的差异并更新 DOM</span></span><br><span class="line">    patchVnode(oldVnode, vnode, insertedVnodeQueue)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果新旧节点不同，vnode 创建对应的 DOM</span></span><br><span class="line">    <span class="comment">// 获取当前的 DOM 元素</span></span><br><span class="line">    elm = oldVnode.elm!</span><br><span class="line">    parent = api.parentNode(elm) <span class="keyword">as</span> Node</span><br><span class="line">    <span class="comment">// 触发 init/create 钩子函数,创建 DOM</span></span><br><span class="line">    createElm(vnode, insertedVnodeQueue)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parent !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果父节点不为空，把 vnode 对应的 DOM 插入到文档中</span></span><br><span class="line">      api.insertBefore(parent, vnode.elm!, api.nextSibling(elm))</span><br><span class="line">      <span class="comment">// 移除老节点</span></span><br><span class="line">      removeVnodes(parent, [oldVnode], <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 执行用户设置的 insert 钩子函数</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; insertedVnodeQueue.length; ++i) &#123;</span><br><span class="line">    insertedVnodeQueue[i].data!.hook!.insert!(insertedVnodeQueue[i])</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 执行模块的 post 钩子函数</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.post.length; ++i) cbs.post[i]()</span><br><span class="line">  <span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="createElm"><a href="#createElm" class="headerlink" title="createElm"></a>createElm</h3><ul><li><p><strong>功能：</strong></p><ul><li>createElm(vnode, insertedVnodeQueue)，返回创建的 DOM 元素</li><li>创建 vnode 对应的 DOM 元素</li></ul></li><li><p><strong>执行过程：</strong></p><ul><li>首先触发<strong>用户</strong>设置的 <strong>init</strong> <strong>钩子</strong>函数</li><li>如果选择器是!，创建评论节点</li><li>如果选择器为空，创建文本节点</li><li>如果选择器不为空<ul><li>解析选择器，设置标签的 id 和 class 属性</li><li>执行<strong>模块</strong>的 <strong>create</strong> <strong>钩子</strong>函数</li><li>如果 vnode 有 children，创建子 vnode 对应的 DOM，追加到 DOM 树</li><li>如果 vnode 的 text 值是 string/number，创建文本节点并追击到 DOM 树</li><li>执行<strong>用户</strong>设置的 <strong>create</strong> <strong>钩子</strong>函数</li><li>如果有用户设置的 insert 钩子函数，把 vnode 添加到队列中</li></ul></li></ul></li><li><p>源码位置：src/package/init.ts</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createElm</span> (<span class="params">vnode: VNode, insertedVnodeQueue: VNodeQueue</span>): <span class="title">Node</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i: any</span><br><span class="line">  <span class="keyword">let</span> data = vnode.data</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (data !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="comment">// 执行用户设置的 init 钩子函数</span></span><br><span class="line">    <span class="keyword">const</span> init = data.hook?.init</span><br><span class="line">    <span class="keyword">if</span> (isDef(init)) &#123;</span><br><span class="line">      init(vnode)</span><br><span class="line">      data = vnode.data</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> children = vnode.children</span><br><span class="line">  <span class="keyword">const</span> sel = vnode.sel</span><br><span class="line">  <span class="keyword">if</span> (sel === <span class="string">&#x27;!&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果选择器是!，创建注释节点</span></span><br><span class="line">    <span class="keyword">if</span> (isUndef(vnode.text)) &#123;</span><br><span class="line">      vnode.text = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    vnode.elm = api.createComment(vnode.text!)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sel !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果选择器不为空</span></span><br><span class="line">    <span class="comment">// 解析选择器</span></span><br><span class="line">    <span class="comment">// Parse selector</span></span><br><span class="line">    <span class="keyword">const</span> hashIdx = sel.indexOf(<span class="string">&#x27;#&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> dotIdx = sel.indexOf(<span class="string">&#x27;.&#x27;</span>, hashIdx)</span><br><span class="line">    <span class="keyword">const</span> hash = hashIdx &gt; <span class="number">0</span> ? hashIdx : sel.length</span><br><span class="line">    <span class="keyword">const</span> dot = dotIdx &gt; <span class="number">0</span> ? dotIdx : sel.length</span><br><span class="line">    <span class="keyword">const</span> tag = hashIdx !== -<span class="number">1</span> || dotIdx !== -<span class="number">1</span> ? sel.slice(<span class="number">0</span>, <span class="built_in">Math</span>.min(hash, dot)) : sel</span><br><span class="line">    <span class="keyword">const</span> elm = vnode.elm = isDef(data) &amp;&amp; isDef(i = data.ns)</span><br><span class="line">      ? api.createElementNS(i, tag)</span><br><span class="line">      : api.createElement(tag)</span><br><span class="line">    <span class="keyword">if</span> (hash &lt; dot) elm.setAttribute(<span class="string">&#x27;id&#x27;</span>, sel.slice(hash + <span class="number">1</span>, dot))</span><br><span class="line">    <span class="keyword">if</span> (dotIdx &gt; <span class="number">0</span>) elm.setAttribute(<span class="string">&#x27;class&#x27;</span>, sel.slice(dot + <span class="number">1</span>).replace(<span class="regexp">/\./g</span>, <span class="string">&#x27; &#x27;</span>))</span><br><span class="line">    <span class="comment">// 执行模块的 create 钩子函数</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.create.length; ++i) cbs.create[i](emptyNode, vnode)</span><br><span class="line">    <span class="comment">// 如果 vnode 中有子节点，创建子 vnode 对应的 DOM 元素并追加到 DOM 树上</span></span><br><span class="line">    <span class="keyword">if</span> (is.array(children)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; children.length; ++i) &#123;</span><br><span class="line">        <span class="keyword">const</span> ch = children[i]</span><br><span class="line">        <span class="keyword">if</span> (ch != <span class="literal">null</span>) &#123;</span><br><span class="line">          api.appendChild(elm, createElm(ch <span class="keyword">as</span> VNode, insertedVnodeQueue))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (is.primitive(vnode.text)) &#123;</span><br><span class="line">      <span class="comment">// 如果 vnode 的 text 值是 string/number，创建文本节点并追加到 DOM 树</span></span><br><span class="line">      api.appendChild(elm, api.createTextNode(vnode.text))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> hook = vnode.data!.hook</span><br><span class="line">    <span class="keyword">if</span> (isDef(hook)) &#123;</span><br><span class="line">      <span class="comment">// 执行用户传入的钩子 create</span></span><br><span class="line">      hook.create?.(emptyNode, vnode)</span><br><span class="line">      <span class="keyword">if</span> (hook.insert) &#123;</span><br><span class="line">        <span class="comment">// 把 vnode 添加到队列中，为后续执行 insert 钩子做准备</span></span><br><span class="line">        insertedVnodeQueue.push(vnode)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果选择器为空，创建文本节点</span></span><br><span class="line">    vnode.elm = api.createTextNode(vnode.text!)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 返回新创建的 DOM                                </span></span><br><span class="line">  <span class="keyword">return</span> vnode.elm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="patchVnode"><a href="#patchVnode" class="headerlink" title="patchVnode"></a>patchVnode</h3><ul><li><p><strong>功能：</strong></p><ul><li>patchVnode(oldVnode, vnode, insertedVnodeQueue)</li><li>对比 oldVnode 和 vnode 的差异，把差异渲染到 DOM</li></ul></li><li><p><strong>执行过程：</strong></p><ul><li><p>首先执行<strong>用户</strong>设置的 <strong>prepatch</strong> <strong>钩子</strong>函数</p></li><li><p>执行 create 钩子函数</p><ul><li>首先执行<strong>模块</strong>的 <strong>create</strong> <strong>钩子</strong>函数</li><li>然后执行<strong>用户</strong>设置的 <strong>create</strong> <strong>钩子</strong>函数</li></ul></li><li><p>如果 <strong>vnode.text</strong> 未定义</p><ul><li>如果 <code>oldVnode.children</code> 和 <code>vnode.children</code> 都有值<ul><li>调用 <code>updateChildren()</code></li><li>使用 diff 算法对比子节点，更新子节点</li></ul></li><li>如果 <code>vnode.children</code> 有值，<code>oldVnode.children</code> 无值<ul><li>清空 DOM 元素</li><li>调用 <code>addVnodes()</code>，批量添加子节点</li></ul></li><li>如果 <code>oldVnode.children</code> 有值，<code>vnode.children</code> 无值<ul><li>调用 <code>removeVnodes()</code>，批量移除子节点</li></ul></li><li>如果 <strong>oldVnode.text</strong> 有值<ul><li>清空 DOM 元素的内容</li></ul></li></ul></li><li><p>如果设置了 <code>vnode.text</code> 并且和和 <code>oldVnode.text</code> 不等</p><ul><li>如果老节点有子节点，全部移除</li><li>设置 DOM 元素的 <code>textContent</code> 为 <code>vnode.text</code></li><li>最后执行用户<strong>设置的</strong> <strong>postpatch</strong> <strong>钩子</strong>函数</li></ul></li><li><p>源码位置：src/package/init.ts</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">function patchVnode (oldVnode: VNode, vnode: VNode, insertedVnodeQueue: VNodeQueue) &#123;</span><br><span class="line">    const hook &#x3D; vnode.data?.hook</span><br><span class="line">    &#x2F;&#x2F; 首先执行用户设置的 prepatch 钩子函数</span><br><span class="line">    hook?.prepatch?.(oldVnode, vnode)</span><br><span class="line">    const elm &#x3D; vnode.elm &#x3D; oldVnode.elm!</span><br><span class="line">    const oldCh &#x3D; oldVnode.children as VNode[]</span><br><span class="line">    const ch &#x3D; vnode.children as VNode[]</span><br><span class="line">    &#x2F;&#x2F; 如果新老 vnode 相同返回</span><br><span class="line">    if (oldVnode &#x3D;&#x3D;&#x3D; vnode) return</span><br><span class="line">    if (vnode.data !&#x3D;&#x3D; undefined) &#123;</span><br><span class="line">      &#x2F;&#x2F; 执行模块的 update 钩子函数</span><br><span class="line">      for (let i &#x3D; 0; i &lt; cbs.update.length; ++i) cbs.update[i](oldVnode, vnode)</span><br><span class="line">      &#x2F;&#x2F; 执行用户设置的 update 钩子函数</span><br><span class="line">      vnode.data.hook?.update?.(oldVnode, vnode)</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 如果 vnode.text 未定义</span><br><span class="line">    if (isUndef(vnode.text)) &#123;</span><br><span class="line">      &#x2F;&#x2F; 如果新老节点都有 children</span><br><span class="line">      if (isDef(oldCh) &amp;&amp; isDef(ch)) &#123;</span><br><span class="line">        &#x2F;&#x2F; 调用 updateChildren 对比子节点，更新子节点</span><br><span class="line">        if (oldCh !&#x3D;&#x3D; ch) updateChildren(elm, oldCh, ch, insertedVnodeQueue)</span><br><span class="line">      &#125; else if (isDef(ch)) &#123;</span><br><span class="line">        &#x2F;&#x2F; 如果新节点有 children，老节点没有 children</span><br><span class="line">        &#x2F;&#x2F; 如果老节点有text，清空dom 元素的内容</span><br><span class="line">        if (isDef(oldVnode.text)) api.setTextContent(elm, &#39;&#39;)</span><br><span class="line">        &#x2F;&#x2F; 批量添加子节点</span><br><span class="line">        addVnodes(elm, null, ch, 0, ch.length - 1, insertedVnodeQueue)</span><br><span class="line">      &#125; else if (isDef(oldCh)) &#123;</span><br><span class="line">        &#x2F;&#x2F; 如果老节点有children，新节点没有children</span><br><span class="line">        &#x2F;&#x2F; 批量移除子节点</span><br><span class="line">        removeVnodes(elm, oldCh, 0, oldCh.length - 1)</span><br><span class="line">      &#125; else if (isDef(oldVnode.text)) &#123;</span><br><span class="line">        &#x2F;&#x2F; 如果老节点有 text，清空 DOM 元素</span><br><span class="line">        api.setTextContent(elm, &#39;&#39;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (oldVnode.text !&#x3D;&#x3D; vnode.text) &#123;</span><br><span class="line">      &#x2F;&#x2F; 如果没有设置 vnode.text</span><br><span class="line">      if (isDef(oldCh)) &#123;</span><br><span class="line">        &#x2F;&#x2F; 如果老节点有 children，移除</span><br><span class="line">        removeVnodes(elm, oldCh, 0, oldCh.length - 1)</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 设置 DOM 元素的 textContent 为 vnode.text</span><br><span class="line">      api.setTextContent(elm, vnode.text!)</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 最后执行用户设置的 postpatch 钩子函数</span><br><span class="line">    hook?.postpatch?.(oldVnode, vnode)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="updateChildren"><a href="#updateChildren" class="headerlink" title="updateChildren"></a>updateChildren</h3><ul><li><p><strong>功能：</strong></p><ul><li>diff 算法的核心，对比新旧节点的 children，更新 DOM</li></ul></li><li><p><strong>执行过程：</strong></p><ul><li>要对比两棵树的差异，我们可以取第一棵树的每一个节点依次和第二课树的每一个节点比较，但是这样的时间复杂度为 O(n^3)</li><li>在DOM 操作的时候我们很少很少会把一个父节点移动/更新到某一个子节点</li><li>因此只需要找<strong>同级别</strong>的子<strong>节点</strong>依次<strong>比较</strong>，然后再找下一级别的节点比较，这样算法的时间复杂度为 O(n)</li></ul><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20200102103653779.2xk8fi4x8tg0.png" alt="image-20200102103653779.png"></p><ul><li>在进行同级别节点比较的时候，首先会对新老节点数组的开始和结尾节点设置标记索引，遍历的过程中移动索引</li><li>在对<strong>开始和结束节点</strong>比较的时候，总共有四种情况<ul><li>oldStartVnode / newStartVnode (旧开始节点 / 新开始节点)</li><li>oldEndVnode / newEndVnode (旧结束节点 / 新结束节点)</li><li>oldStartVnode / oldEndVnode (旧开始节点 / 新结束节点)</li><li>oldEndVnode / newStartVnode (旧结束节点 / 新开始节点)</li></ul></li></ul><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20200109184608649.5sn8s9wdufk0.png" alt="image-20200109184608649"></p><ul><li>开始节点和结束节点比较，这两种情况类似<ul><li>oldStartVnode / newStartVnode (旧开始节点 / 新开始节点)</li><li>oldEndVnode / newEndVnode (旧结束节点 / 新结束节点)</li></ul></li><li>如果 oldStartVnode 和 newStartVnode 是 sameVnode (key 和 sel 相同)<ul><li>调用 patchVnode() 对比和更新节点</li><li>把旧开始和新开始索引往后移动 oldStartIdx++ / oldEndIdx++</li></ul></li></ul><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20200103121812840.6hxchhphz4c0.png" alt="image-20200103121812840"></p><ul><li>oldStartVnode / newEndVnode (旧开始节点 / 新结束节点) 相同<ul><li>调用 patchVnode() 对比和更新节点</li><li>把 oldStartVnode 对应的 DOM 元素，移动到右边 - 更新索引</li></ul></li></ul><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20200103125428541.3uajwl6tgi60.png" alt="image-20200103125428541"></p><ul><li>oldEndVnode / newStartVnode (旧结束节点 / 新开始节点) 相同<ul><li>调用 patchVnode() 对比和更新节点</li><li>把 oldEndVnode 对应的 DOM 元素，移动到左边</li><li>更新索引</li></ul></li></ul><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20200103125735048.3w57o49590o0.png" alt="image-20200103125735048"></p><ul><li>如果不是以上四种情况<ul><li>遍历新节点，使用 newStartNode 的 key 在老节点数组中找相同节点</li><li>如果没有找到，说明 newStartNode 是新节点<ul><li>创建新节点对应的 DOM 元素，插入到 DOM 树中</li></ul></li><li>如果找到了<ul><li>判断新节点和找到的老节点的 sel 选择器是否相同</li><li>如果不相同，说明节点被修改了<ul><li>重新创建对应的 DOM 元素，插入到 DOM 树中</li></ul></li><li>如果相同，把 elmToMove 对应的 DOM 元素，移动到左边</li></ul></li></ul></li></ul><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20200109184822439.720rfdretlo0.png" alt="image-20200109184822439"></p><ul><li>循环结束<ul><li>当老节点的所有子节点先遍历完 (oldStartIdx &gt; oldEndIdx)，循环结束</li><li>新节点的所有子节点先遍历完 (newStartIdx &gt; newEndIdx)，循环结束</li></ul></li><li>如果老节点的数组先遍历完(oldStartIdx &gt; oldEndIdx)，说明新节点有剩余，把剩余节点批量插入到右边</li></ul><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20200103150918335.41xk9i229f00.png" alt="image-20200103150918335"></p><p>​</p><ul><li>如果新节点的数组先遍历完(newStartIdx &gt; newEndIdx)，说明老节点有剩余，把剩余节点批量删除</li></ul><p><img lazyload src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/wkxk/blog-images@master/images/image-20200109194751093.ldt2k0j95rk.png" alt="image-20200109194751093"></p></li><li><p>源码位置：src/package/init.ts</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateChildren</span> (<span class="params">parentElm: Node,</span></span></span><br><span class="line"><span class="function"><span class="params">  oldCh: VNode[],</span></span></span><br><span class="line"><span class="function"><span class="params">  newCh: VNode[],</span></span></span><br><span class="line"><span class="function"><span class="params">  insertedVnodeQueue: VNodeQueue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> oldStartIdx = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> newStartIdx = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> oldEndIdx = oldCh.length - <span class="number">1</span></span><br><span class="line">  <span class="keyword">let</span> oldStartVnode = oldCh[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">let</span> oldEndVnode = oldCh[oldEndIdx]</span><br><span class="line">  <span class="keyword">let</span> newEndIdx = newCh.length - <span class="number">1</span></span><br><span class="line">  <span class="keyword">let</span> newStartVnode = newCh[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">let</span> newEndVnode = newCh[newEndIdx]</span><br><span class="line">  <span class="keyword">let</span> oldKeyToIdx: KeyToIndexMap | <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">let</span> idxInOld: number</span><br><span class="line">  <span class="keyword">let</span> elmToMove: VNode</span><br><span class="line">  <span class="keyword">let</span> before: any</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">    <span class="comment">// 索引变化后，可能会把节点设置为空</span></span><br><span class="line">    <span class="keyword">if</span> (oldStartVnode == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 节点为空移动索引</span></span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx] <span class="comment">// Vnode might have been moved left</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldEndVnode == <span class="literal">null</span>) &#123;</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStartVnode == <span class="literal">null</span>) &#123;</span><br><span class="line">      newStartVnode = newCh[++newStartIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newEndVnode == <span class="literal">null</span>) &#123;</span><br><span class="line">      newEndVnode = newCh[--newEndIdx]</span><br><span class="line">    <span class="comment">// 比较开始和结束节点的四种情况</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sameVnode(oldStartVnode, newStartVnode)) &#123;</span><br><span class="line">      <span class="comment">// 1. 比较老开始节点和新的开始节点</span></span><br><span class="line">      patchVnode(oldStartVnode, newStartVnode, insertedVnodeQueue)</span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx]</span><br><span class="line">      newStartVnode = newCh[++newStartIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sameVnode(oldEndVnode, newEndVnode)) &#123;</span><br><span class="line">      <span class="comment">// 2. 比较老结束节点和新的结束节点</span></span><br><span class="line">      patchVnode(oldEndVnode, newEndVnode, insertedVnodeQueue)</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx]</span><br><span class="line">      newEndVnode = newCh[--newEndIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sameVnode(oldStartVnode, newEndVnode)) &#123; <span class="comment">// Vnode moved right</span></span><br><span class="line">      <span class="comment">// 3. 比较老开始节点和新的结束节点</span></span><br><span class="line">      patchVnode(oldStartVnode, newEndVnode, insertedVnodeQueue)</span><br><span class="line">      api.insertBefore(parentElm, oldStartVnode.elm!, api.nextSibling(oldEndVnode.elm!))</span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx]</span><br><span class="line">      newEndVnode = newCh[--newEndIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sameVnode(oldEndVnode, newStartVnode)) &#123; <span class="comment">// Vnode moved left</span></span><br><span class="line">      <span class="comment">// 4. 比较老结束节点和新的开始节点</span></span><br><span class="line">      patchVnode(oldEndVnode, newStartVnode, insertedVnodeQueue)</span><br><span class="line">      api.insertBefore(parentElm, oldEndVnode.elm!, oldStartVnode.elm!)</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx]</span><br><span class="line">      newStartVnode = newCh[++newStartIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 开始节点和结束节点都不相同</span></span><br><span class="line">      <span class="comment">// 使用 newStartNode 的 key 再老节点数组中找相同节点</span></span><br><span class="line">      <span class="comment">// 先设置记录 key 和 index 的对象</span></span><br><span class="line">      <span class="keyword">if</span> (oldKeyToIdx === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 遍历 newStartVnode, 从老的节点中找相同 key 的 oldVnode 的索引</span></span><br><span class="line">      idxInOld = oldKeyToIdx[newStartVnode.key <span class="keyword">as</span> string]</span><br><span class="line">      <span class="comment">// 如果是新的vnode</span></span><br><span class="line">      <span class="keyword">if</span> (isUndef(idxInOld)) &#123; <span class="comment">// New element</span></span><br><span class="line">        <span class="comment">// 如果没找到，newStartNode 是新节点</span></span><br><span class="line">        <span class="comment">// 创建元素插入 DOM 树</span></span><br><span class="line">        api.insertBefore(parentElm, createElm(newStartVnode, insertedVnodeQueue), oldStartVnode.elm!)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果找到相同 key 相同的老节点，记录到 elmToMove 遍历</span></span><br><span class="line">        elmToMove = oldCh[idxInOld]</span><br><span class="line">        <span class="keyword">if</span> (elmToMove.sel !== newStartVnode.sel) &#123;</span><br><span class="line">          <span class="comment">// 如果新旧节点的选择器不同</span></span><br><span class="line">          <span class="comment">// 创建新开始节点对应的 DOM 元素，插入到 DOM 树中</span></span><br><span class="line">          api.insertBefore(parentElm, createElm(newStartVnode, insertedVnodeQueue), oldStartVnode.elm!)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 如果相同，patchVnode()</span></span><br><span class="line">          <span class="comment">// 把 elmToMove 对应的 DOM 元素，移动到左边</span></span><br><span class="line">          patchVnode(elmToMove, newStartVnode, insertedVnodeQueue)</span><br><span class="line">          oldCh[idxInOld] = <span class="literal">undefined</span> <span class="keyword">as</span> any</span><br><span class="line">          api.insertBefore(parentElm, elmToMove.elm!, oldStartVnode.elm!)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 重新给 newStartVnode 赋值，指向下一个新节点</span></span><br><span class="line">      newStartVnode = newCh[++newStartIdx]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 循环结束，老节点数组先遍历完成或者新节点数组先遍历完成</span></span><br><span class="line">  <span class="keyword">if</span> (oldStartIdx &lt;= oldEndIdx || newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">    <span class="keyword">if</span> (oldStartIdx &gt; oldEndIdx) &#123;</span><br><span class="line">      <span class="comment">// 如果老节点数组先遍历完成，说明有新的节点剩余</span></span><br><span class="line">      <span class="comment">// 把剩余的新节点都插入到右边</span></span><br><span class="line">      before = newCh[newEndIdx + <span class="number">1</span>] == <span class="literal">null</span> ? <span class="literal">null</span> : newCh[newEndIdx + <span class="number">1</span>].elm</span><br><span class="line">      addVnodes(parentElm, before, newCh, newStartIdx, newEndIdx, insertedVnodeQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 如果新节点数组先遍历完成，说明老节点有剩余</span></span><br><span class="line">      <span class="comment">// 批量删除老节点</span></span><br><span class="line">      removeVnodes(parentElm, oldCh, oldStartIdx, oldEndIdx)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="简述-Diff-算法的执行过程"><a href="#简述-Diff-算法的执行过程" class="headerlink" title="简述 Diff 算法的执行过程"></a>简述 Diff 算法的执行过程</h2><ul><li><p>diff算法是一种通过同层的树节点进行比较的高效算法，避免了对树进行逐层搜索遍历，所以时间复杂度只有 O(n)。</p></li><li><p>diff算法有两个比较显著的特点：</p><ul><li>1、比较只会在同层级进行, 不会跨层级比较。</li><li>2、在diff比较的过程中，循环从两边向中间收拢。</li></ul></li><li><p>diff流程：</p><ul><li>1 、首先定义 oldStartIdx、newStartIdx、oldEndIdx 以及 newEndIdx 分别是新老两个 VNode 的两边的索引。</li><li>2、接下来是一个 while 循环，在这过程中，oldStartIdx、newStartIdx、oldEndIdx 以及 newEndIdx 会逐渐向中间靠拢。while 循环的退出条件是直到老节点或者新节点的开始位置大于结束位置。<ul><li>while 循环中会遇到四种情况：<ul><li>情形一：当新老 VNode 节点的 start 是同一节点时，直接 patchVnode 即可，同时新老 VNode 节点的开始索引都加 1。</li><li>情形二：当新老 VNode 节点的 end 是同一节点时，直接 patchVnode 即可，同时新老 VNode 节点的结束索引都减 1。</li><li>情形三：当老 VNode 节点的 start 和新 VNode 节点的 end 是同一节点时，这说明这次数据更新后 oldStartVnode 已经跑到了 oldEndVnode 后面去了。这时候在 patchVnode 后，还需要将当前真实 dom 节点移动到 oldEndVnode 的后面，同时老 VNode 节点开始索引加 1，新 VNode 节点的结束索引减 1。</li><li>情形四：当老 VNode 节点的 end 和新 VNode 节点的 start 是同一节点时，这说明这次数据更新后 oldEndVnode 跑到了 oldStartVnode 的前面去了。这时候在 patchVnode 后，还需要将当前真实 dom 节点移动到 oldStartVnode 的前面，同时老 VNode 节点结束索引减 1，新 VNode 节点的开始索引加 1。</li></ul></li></ul></li><li>3、while 循环的退出条件是直到老节点或者新节点的开始位置大于结束位置。<ul><li>情形一：如果在循环中，oldStartIdx大于oldEndIdx了，那就表示oldChildren比newChildren先循环完毕，那么newChildren里面剩余的节点都是需要新增的节点，把[newStartIdx, newEndIdx]之间的所有节点都插入到DOM中</li><li>情形二：如果在循环中，newStartIdx大于newEndIdx了，那就表示newChildren比oldChildren先循环完毕，那么oldChildren里面剩余的节点都是需要删除的节点，把[oldStartIdx, oldEndIdx]之间的所有节点都删除</li></ul></li></ul></li></ul></div><div class="post-copyright-info"><div class="article-copyright-info-container"><ul><li>Post title：Snabbdom深入剖析</li><li>Post author：wkxk</li><li>Create time：2021-04-23 14:37:25</li><li>Post link：http://www.iwkxk.com/2021/04/23/Snabbdom深入剖析/</li><li>Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.</li></ul></div></div><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/2021/04/23/Vue%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93/"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">Vue源码剖析(一) — Vue首次渲染</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/2021/04/23/Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86%E6%A8%A1%E6%8B%9F/"><span class="title flex-center"><span class="post-nav-title-item">Vue响应式原理模拟</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div><div class="comment-container"><div class="comments-container"><div id="comment-anchor"></div><div class="comment-area-title"><i class="fas fa-comments">&nbsp;Comments</i></div><div id="gitalk-container"></div><script data-pjax src="//cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script><script data-pjax>function loadGitalk(){let e=decodeURI(location.pathname);e.length>50&&(e=e.substring(0,47)+"...");try{Gitalk&&new Gitalk({clientID:"95ee2e163d7f20d8de19",clientSecret:"ad675c3bdff4af0fa754ab836be591c2e3aeb688",repo:"my-gitalk",owner:"wkxk",admin:["wkxk"],id:e,language:"zh"}).render("gitalk-container")}catch(e){window.Gitalk=null}}{const e=setTimeout(()=>{loadGitalk(),clearTimeout(e)},1e3)}</script></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2020</span>&nbsp;-&nbsp; 2021&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">wkxk</a></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item"><span id="busuanzi_container_site_uv">Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp; </span><span id="busuanzi_container_site_pv">Totalview&nbsp;<span id="busuanzi_value_site_pv"></span></span></div><div class="theme-info info-item">Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.2</a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item page-aside-toggle"><i class="fas fa-outdent"></i></li><li class="go-comment"><i class="fas fa-comment"></i></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-expand-width flex-center"><i class="fas fa-arrows-alt-h"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><aside class="page-aside"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-Virtual-DOM"><span class="nav-number">1.</span> <span class="nav-text">什么是 Virtual DOM</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8-Virtual-DOM"><span class="nav-number">2.</span> <span class="nav-text">为什么使用 Virtual DOM</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F-DOM-%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">3.</span> <span class="nav-text">虚拟 DOM 的作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Virtual-DOM-%E5%BA%93"><span class="nav-number">4.</span> <span class="nav-text">Virtual DOM 库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA"><span class="nav-number">5.</span> <span class="nav-text">案例演示</span></a></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#Snabbdom-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-number"></span> <span class="nav-text">Snabbdom 基本使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="nav-number">1.</span> <span class="nav-text">创建项目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5-Snabbdom"><span class="nav-number">2.</span> <span class="nav-text">导入 Snabbdom</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Snabbdom-%E6%96%87%E6%A1%A3"><span class="nav-number">3.</span> <span class="nav-text">Snabbdom 文档</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Snabbdom"><span class="nav-number">3.1.</span> <span class="nav-text">安装 Snabbdom</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5-Snabbdom-1"><span class="nav-number">3.2.</span> <span class="nav-text">导入 Snabbdom</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E6%BC%94%E7%A4%BA"><span class="nav-number">4.</span> <span class="nav-text">代码演示</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-number">4.1.</span> <span class="nav-text">基本使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97"><span class="nav-number">5.</span> <span class="nav-text">模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="nav-number">5.1.</span> <span class="nav-text">常用模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8"><span class="nav-number">5.2.</span> <span class="nav-text">模块使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E6%BC%94%E7%A4%BA-1"><span class="nav-number">5.3.</span> <span class="nav-text">代码演示</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Snabbdom-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-number"></span> <span class="nav-text">Snabbdom 源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%AD%A6%E4%B9%A0%E6%BA%90%E7%A0%81"><span class="nav-number">1.1.</span> <span class="nav-text">如何学习源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Snabbdom-%E7%9A%84%E6%A0%B8%E5%BF%83"><span class="nav-number">1.2.</span> <span class="nav-text">Snabbdom 的核心</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Snabbdom-%E6%BA%90%E7%A0%81"><span class="nav-number">1.3.</span> <span class="nav-text">Snabbdom 源码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#h-%E5%87%BD%E6%95%B0"><span class="nav-number">2.</span> <span class="nav-text">h 函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VNode"><span class="nav-number">3.</span> <span class="nav-text">VNode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#snabbdom"><span class="nav-number">4.</span> <span class="nav-text">snabbdom</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#init"><span class="nav-number">4.1.</span> <span class="nav-text">init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#patch"><span class="nav-number">4.2.</span> <span class="nav-text">patch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#createElm"><span class="nav-number">4.3.</span> <span class="nav-text">createElm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#patchVnode"><span class="nav-number">4.4.</span> <span class="nav-text">patchVnode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#updateChildren"><span class="nav-number">4.5.</span> <span class="nav-text">updateChildren</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E8%BF%B0-Diff-%E7%AE%97%E6%B3%95%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="nav-number">5.</span> <span class="nav-text">简述 Diff 算法的执行过程</span></a></li></ol></li></div></div></aside><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/dark-light-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/local-search.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/code-copy.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/lazyload.js"></script><div class="post-scripts pjax"><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/toc.js"></script></div><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.2/source/js/libs/pjax.min.js"></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=new Pjax({selectors:["head title",".page-container",".pjax"],history:!0,debug:!1,cacheBust:!1,timeout:0,analytics:!1,currentUrlFullReload:!1,scrollRestoration:!1});document.addEventListener("pjax:send",()=>{KEEP.utils.pjaxProgressBarStart()}),document.addEventListener("pjax:complete",()=>{KEEP.utils.pjaxProgressBarEnd(),e.executeScripts(document.querySelectorAll("script[data-pjax], .pjax script")),KEEP.refresh()})})</script></body></html>